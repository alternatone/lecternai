<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week Viewer - Lectern</title>
    <link rel="stylesheet" href="styles/lectern-core.css">
    <script src="js/db-schema.js"></script>
    <script src="js/validation.js"></script>
    <style>
        .user-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--light-bg);
            border-bottom: 1px solid #e9ecef;
        }
        .user-header .user-info { flex: 1; }
        .user-header .admin-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        /* Loading state styles */
        .page-loading {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .page-loaded {
            opacity: 1;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        .loading-spinner::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Discussion textarea styles */
        .discussion-section textarea,
        textarea[id^="response-"],
        textarea[id^="reply-text-"],
        textarea[id^="post-edit-text-"],
        textarea[id^="reply-edit-text-"] {
            font-family: 'Benton Sans', Arial, sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            resize: vertical;
            transition: border-color 0.2s ease;
            background: #fff;
        }
        .discussion-section textarea:focus,
        textarea[id^="response-"]:focus,
        textarea[id^="reply-text-"]:focus,
        textarea[id^="post-edit-text-"]:focus,
        textarea[id^="reply-edit-text-"]:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(16, 100, 112, 0.1);
        }
        .discussion-section textarea::placeholder,
        textarea[id^="response-"]::placeholder,
        textarea[id^="reply-text-"]::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div id="user-header" class="user-header" style="display: none;"></div>

    <header>
        <div class="header-content">
            <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                <img src="brand-assets/aquinas-logo.svg" alt="Aquinas Institute" class="logo-icon" style="width: 2.5rem; height: 2.5rem;">
                <h1>Lectern</h1>
            </a>
            <div id="header-actions"></div>
        </div>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="container">
        <div class="loading-spinner">Loading week content...</div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="main-content" class="container page-loading">
        <div class="breadcrumb">
            <a href="index.html">Home</a>
            <span>›</span>
            <a href="module-overview.html">Module Overview</a>
            <span>›</span>
            <span id="breadcrumb-week">Week</span>
        </div>

        <h2 class="page-title">
            <span id="page-title">Loading...</span>
        </h2>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p style="text-align: center; color: #6c757d; margin-bottom: 2rem;" id="progress-text">Page 1 of 5</p>

        <!-- Page Content Container -->
        <div id="page-content"></div>

        <!-- Navigation -->
        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
            <div style="display: flex; gap: 1rem;">
                <button class="btn-f olive" type="button" onclick="goToModuleOverview()">← Back to Module Overview</button>
                <button class="btn-f olive" type="button" id="prev-btn" onclick="previousPage()" style="display: none;">← Previous</button>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-f olive" type="button" id="save-exit-btn" onclick="saveProgressAndExit()" style="display: none;">Save Progress & Exit</button>
                <button class="btn-f gold" type="button" id="next-btn" onclick="nextPage()">Next →</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { dataService } from './js/data-service-supabase.js';
        import { requireActiveUser, logout, canAccessModule } from './js/auth.js';

        let currentView = 'student';
        let currentWeek = null;
        let currentPage = 1;
        let currentModuleId = null;
        let isParticipantMode = false;
        let currentUser = null;

        function renderUserHeader() {
            const header = document.getElementById('user-header');
            const isAdmin = currentUser.role === 'admin';

            header.innerHTML = `
                <span class="user-info">
                    <strong>${currentUser.name || currentUser.email}</strong>
                    ${isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                </span>
                ${isAdmin ? '<a href="admin-users.html" class="btn-f olive" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Manage Users</a>' : ''}
                <button onclick="logoutUser()" class="btn-f olive" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Logout</button>
            `;
            header.style.display = 'flex';
        }
        let totalPages = 6; // Now 6 pages with Zoom Prep

        // Convert video URLs to embed URLs
        function getVideoEmbedUrl(url) {
            if (!url) return null;

            // YouTube URL patterns
            const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
            }

            // Vimeo URL patterns
            const vimeoRegex = /vimeo\.com\/(\d+)/;
            const vimeoMatch = url.match(vimeoRegex);
            if (vimeoMatch) {
                return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
            }

            // If already an embed URL, return it
            if (url.includes('youtube.com/embed/') || url.includes('player.vimeo.com/video/')) {
                return url;
            }

            // Not a supported video platform
            return null;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Generate consistent color for author name
        const authorColors = {};
        const colorPalette = [
            '#2563eb', // blue
            '#059669', // emerald
            '#7c3aed', // violet
            '#db2777', // pink
            '#ea580c', // orange
            '#0891b2', // cyan
            '#4f46e5', // indigo
            '#16a34a', // green
            '#9333ea', // purple
            '#dc2626', // red
            '#0d9488', // teal
            '#ca8a04', // yellow
        ];
        function getAuthorColor(authorName) {
            if (!authorName) return colorPalette[0];
            if (authorColors[authorName]) return authorColors[authorName];

            // Simple hash of author name to pick a consistent color
            let hash = 0;
            for (let i = 0; i < authorName.length; i++) {
                hash = ((hash << 5) - hash) + authorName.charCodeAt(i);
                hash = hash & hash;
            }
            const colorIndex = Math.abs(hash) % colorPalette.length;
            authorColors[authorName] = colorPalette[colorIndex];
            return authorColors[authorName];
        }

        // Format text with basic markdown support (line breaks, bullet points)
        function formatText(text) {
            if (!text) return '';

            // Escape HTML to prevent XSS
            const escaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Convert line breaks to <br>
            let formatted = escaped.replace(/\n/g, '<br>');

            // Convert markdown-style bullets to HTML list items
            const lines = formatted.split('<br>');
            let inList = false;
            let result = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const isBullet = /^[\*\-\•]\s/.test(line);

                if (isBullet) {
                    if (!inList) {
                        result.push('<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">');
                        inList = true;
                    }
                    const content = line.replace(/^[\*\-\•]\s/, '');
                    result.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    result.push(line + '<br>');
                }
            }

            if (inList) {
                result.push('</ul>');
            }

            return result.join('');
        }

        async function setView(view, fromToggle = false) {
            // Only redirect to index.html if explicitly toggling to student view (not on page load)
            if (view === 'student' && fromToggle) {
                dataService.setCurrentView('student');
                window.location.href = 'index.html';
                return;
            }

            currentView = view;

            if (view === 'student') {
                dataService.setCurrentView('student');
            } else {
                dataService.setCurrentView('admin');
            }
            // Note: renderPage is called after loadWeekData in onload
        }

        function getWeekIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('week'));
        }

        function getPageFromURL() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('page')) || 1;
        }

        async function loadWeekData() {
            const weekId = getWeekIdFromURL();

            // Load weeks using DataService
            currentModuleId = dataService.getCurrentModuleId();
            if (currentModuleId) {
                currentWeek = await dataService.getWeek(currentModuleId, weekId);
            }

            if (!currentWeek) {
                document.getElementById('page-content').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 2rem;">Week not found.</p>';
                return false;
            }

            currentPage = getPageFromURL();
            updateBreadcrumb();
            return true;
        }

        function updateBreadcrumb() {
            document.getElementById('breadcrumb-week').textContent = `Week ${currentWeek.id}: ${currentWeek.title}`;
        }

        function updateProgress() {
            const progress = (currentPage / totalPages) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `Page ${currentPage} of ${totalPages}`;
        }

        async function renderPage() {
            if (!currentWeek) {
                return;
            }

            const pageData = currentWeek.pages[currentPage - 1];
            if (!pageData) {
                document.getElementById('page-content').innerHTML = '<p style="text-align: center; color: #dc3545;">Page data not found.</p>';
                return;
            }

            document.getElementById('page-title').textContent = pageData.title;
            updateProgress();

            const content = document.getElementById('page-content');

            // Render based on page type
            if (pageData.type === 'discussion') {
                await renderDiscussionPage(pageData, content);
            } else if (pageData.type === 'intro') {
                renderIntroPage(pageData, content);
            } else if (pageData.type === 'reading') {
                renderReadingPage(pageData, content);
            }

            // Update navigation buttons
            document.getElementById('prev-btn').style.display = currentPage === 1 ? 'none' : 'block';
            document.getElementById('next-btn').textContent = currentPage === totalPages ? 'Finish →' : 'Next →';

            // Show Save Progress & Exit button only for students (not on last page)
            const saveExitBtn = document.getElementById('save-exit-btn');
            if (currentView === 'student' && currentPage < totalPages) {
                saveExitBtn.style.display = 'block';
            } else {
                saveExitBtn.style.display = 'none';
            }
        }

        async function renderDiscussionPage(pageData, container) {
            const questions = pageData.questions || [];
            const pageIndex = currentPage - 1;

            // Determine read-only based on module status and participant mode
            // Read-only when: archived, OR draft without participant mode (preview for testing links)
            // Full read/write when: launched, OR draft WITH participant mode (admin simulating student)
            const module = await dataService.getModule(currentModuleId);
            const moduleStatus = module ? module.status : 'draft';
            const isReadOnly = moduleStatus === 'archived' || (moduleStatus === 'draft' && !isParticipantMode);

            let html = '<div class="card" style="width: 100%;">';

            // Show read-only notice
            if (isReadOnly) {
                const noticeText = moduleStatus === 'archived'
                    ? '<strong>Archived Module:</strong> This module is archived. Discussion posts and replies are disabled.'
                    : '<strong>Preview Mode:</strong> This is a read-only preview for testing links and embeds. Use Participant Mode to test discussions.';
                html += `<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.9rem;">
                    ${noticeText}
                </div>`;
            }

            if (questions.length > 0) {
                for (let index = 0; index < questions.length; index++) {
                    const question = questions[index];

                    // Show discussion thread for everyone (isolated per module)
                    const posts = await dataService.getDiscussionPosts(currentModuleId, currentWeek.id, pageIndex, index);

                    // Open question box
                    html += `
                        <div style="background: transparent; border: 2px solid var(--teal); border-radius: 16px; padding: 1.75rem; margin-bottom: 3rem; position: relative;">
                            <h3 style="position: absolute; top: -0.7rem; left: 1.5rem; background: white; padding: 0 0.75rem; font-size: 1rem; color: var(--teal); margin: 0;">Question ${index + 1}</h3>
                            <div style="font-family: 'Adobe Garamond Pro', Georgia, serif; font-size: 1.3rem; font-style: italic; color: #2c3e50; line-height: 1.6; margin-bottom: 1.5rem;">${question.text}</div>
                    `;

                    // Show input form when module is launched (not read-only)
                    if (!isReadOnly) {
                        html += `
                            <div class="discussion-section">
                                <div class="discussion-form" style="margin-bottom: 2rem;">
                                    <textarea id="response-${index}" placeholder="Share your thoughts on this question..." style="min-height: 120px; width: 100%; padding: 0.875rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Benton Sans', Arial, sans-serif; font-size: 0.95rem; resize: vertical; transition: border-color 0.2s ease;"></textarea>
                                    <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                                        <button class="btn-f teal" onclick="postDiscussion(${index})">Post Response</button>
                                    </div>
                                </div>
                                <div id="discussion-thread-${index}">
                                    ${renderDiscussionThread(posts, pageIndex, index, false, currentUser.id)}
                                </div>
                            </div>
                        `;
                    } else {
                        // Read-only mode (draft preview or archived) - show threads but no input
                        html += `
                            <div class="discussion-section">
                                <div id="discussion-thread-${index}">
                                    ${renderDiscussionThread(posts, pageIndex, index, true, currentUser.id)}
                                </div>
                            </div>
                        `;
                    }

                    // Close question box
                    html += '</div>';

                    if (index < questions.length - 1) {
                        html += '<hr style="margin: 2rem 0;">';
                    }
                }
            } else {
                html += '<p style="color: #6c757d; text-align: center;">No questions available for this discussion.</p>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderDiscussionThread(posts, pageIndex, questionIndex, readOnly = false, currentUserId = null) {
            if (!posts || posts.length === 0) {
                const msg = readOnly ? 'No discussion posts yet.' : 'No discussion posts yet. Be the first to share!';
                return `<p style="color: #6c757d; font-style: italic; margin-top: 1rem;">${msg}</p>`;
            }

            let html = '';
            posts.forEach(post => {
                const postDate = new Date(post.createdAt).toLocaleDateString();
                const postTime = new Date(post.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isOwnPost = currentUserId && post.userId === currentUserId;

                const editedText = post.editedAt ? ' <span style="font-size: 0.75rem; color: #6c757d;">(edited)</span>' : '';
                const postAuthorColor = getAuthorColor(post.author);
                html += `
                    <div style="background: #eef0e8; padding: 1rem 1.25rem; margin-bottom: 1rem; border-radius: 12px 12px 12px 4px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong style="color: ${postAuthorColor};">${escapeHtml(post.author) || 'Anonymous'}${editedText}</strong>
                            <span style="color: #6c757d; font-size: 0.85rem;">${postDate} at ${postTime}</span>
                        </div>
                        <div id="post-content-${post.id}">
                            <p style="margin: 0.5rem 0; white-space: pre-wrap;">${escapeHtml(post.content)}</p>
                        </div>
                        <div id="post-edit-form-${post.id}" style="display: none; margin-top: 0.5rem;">
                            <textarea id="post-edit-text-${post.id}" style="width: 100%; min-height: 100px; margin-bottom: 0.5rem; padding: 0.875rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Benton Sans', Arial, sans-serif; font-size: 0.95rem;">${escapeHtml(post.content)}</textarea>
                            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                <button class="btn-f teal" onclick="savePostEdit(${pageIndex}, ${questionIndex}, ${post.id})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Save</button>
                                <button class="btn-f olive" onclick="cancelPostEdit(${post.id})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Cancel</button>
                            </div>
                        </div>
                `;

                // Show buttons for non-read-only mode
                if (!readOnly) {
                    html += `<div id="post-actions-${post.id}" style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.75rem;">
                            <button class="btn-f olive" onclick="toggleReplyForm(${post.id})" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Reply</button>`;

                    // Only show Edit/Delete for own posts
                    if (isOwnPost) {
                        html += `
                            <button class="btn-f gold" onclick="editPost(${post.id})" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Edit</button>
                            <button class="btn-f red" onclick="deletePost(${post.id})" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Delete</button>`;
                    }

                    html += `</div>

                        <div id="reply-form-${post.id}" style="display: none; margin-top: 1rem; padding-left: 1rem; border-left: 2px solid #dee2e6;">
                            <textarea id="reply-text-${post.id}" placeholder="Write your reply..." style="width: 100%; min-height: 80px; margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Benton Sans', Arial, sans-serif; font-size: 0.9rem;"></textarea>
                            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                <button class="btn-f teal" onclick="postReply(${pageIndex}, ${questionIndex}, ${post.id})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Post Reply</button>
                                <button class="btn-f olive" onclick="toggleReplyForm(${post.id})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Cancel</button>
                            </div>
                        </div>
                    `;
                }

                // Render replies
                if (post.replies && post.replies.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-left: 2rem;">';
                    post.replies.forEach(reply => {
                        const replyDate = new Date(reply.createdAt).toLocaleDateString();
                        const replyTime = new Date(reply.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const replyEditedText = reply.editedAt ? ' <span style="font-size: 0.7rem; color: #6c757d;">(edited)</span>' : '';
                        const replyAuthorColor = getAuthorColor(reply.author);
                        const isOwnReply = currentUserId && reply.userId === currentUserId;

                        html += `
                            <div style="background: white; border: 1px solid #e5e7eb; padding: 0.75rem 1rem; margin-bottom: 0.75rem; border-radius: 12px 12px 4px 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong style="color: ${replyAuthorColor}; font-size: 0.9rem;">${escapeHtml(reply.author) || 'Anonymous'}${replyEditedText}</strong>
                                    <span style="color: #6c757d; font-size: 0.8rem;">${replyDate} at ${replyTime}</span>
                                </div>
                                <div id="reply-content-${reply.id}">
                                    <p style="margin: 0; font-size: 0.9rem; white-space: pre-wrap;">${escapeHtml(reply.content)}</p>
                                </div>
                                <div id="reply-edit-form-${reply.id}" style="display: none; margin-top: 0.5rem;">
                                    <textarea id="reply-edit-text-${reply.id}" style="width: 100%; min-height: 70px; margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Benton Sans', Arial, sans-serif; font-size: 0.9rem;">${escapeHtml(reply.content)}</textarea>
                                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                        <button class="btn-f teal" onclick="saveReplyEdit(${pageIndex}, ${questionIndex}, ${post.id}, ${reply.id})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Save</button>
                                        <button class="btn-f olive" onclick="cancelReplyEdit(${reply.id})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Cancel</button>
                                    </div>
                                </div>
                                ${!readOnly && isOwnReply ? `
                                    <div id="reply-actions-${reply.id}" style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem;">
                                        <button class="btn-f gold" onclick="editReply(${reply.id})" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">Edit</button>
                                        <button class="btn-f red" onclick="deleteReply(${reply.id})" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div>';
            });
            html += '</div>';

            return html;
        }

        function renderIntroPage(pageData, container) {
            let html = `
                <div style="background: transparent; border: 2px solid var(--teal); border-radius: 16px; padding: 1.75rem; position: relative;">
                    <h3 style="position: absolute; top: -0.7rem; left: 1.5rem; background: white; padding: 0 0.75rem; font-size: 1rem; color: var(--teal); margin: 0;">${pageData.title}</h3>
            `;

            // Show intro text
            if (pageData.content) {
                html += `<div style="margin-top: 1rem; width: 100%;">${formatText(pageData.content)}</div>`;
            }

            // Show videos if any
            const videos = pageData.videos || [];
            if (videos.length > 0) {
                html += '<div class="video-playlist" style="margin-top: 2rem;">';
                videos.forEach(video => {
                    const durationText = video.duration ? ` (${video.duration})` : '';
                    const embedUrl = getVideoEmbedUrl(video.url);

                    html += `
                        <div class="playlist-item" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <strong>${video.title}${durationText}</strong>
                            ${embedUrl ? `
                                <div style="margin-top: 1rem; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                                    <iframe src="${embedUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            ` : `
                                <div style="margin-top: 0.5rem; display: flex; justify-content: flex-end;">
                                    <a href="${video.url}" target="_blank" class="btn-f teal" style="padding: 0.5rem 1rem; font-size: 0.9rem; text-decoration: none;">View Resource</a>
                                </div>
                            `}
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderReadingPage(pageData, container) {
            const resources = pageData.resources || [];
            const videos = pageData.videos || [];

            let html = '<div class="card">';
            html += `<h3>${pageData.title}</h3>`;

            if (resources.length === 0 && videos.length === 0) {
                html += '<p style="color: #6c757d; text-align: center; padding: 2rem;">No resources available yet.</p>';
            } else {
                if (resources.length > 0) {
                    html += '<div class="resource-list" style="margin-top: 1.5rem;">';
                    resources.forEach(resource => {
                        const hasUrl = resource.url && resource.url.trim();
                        html += `
                            <div class="resource-item" style="position: relative; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="padding-right: ${hasUrl ? '140px' : '0'};">
                                    <strong>${resource.title}</strong>
                                    ${resource.description ? `<p style="color: #6c757d; margin-top: 0.5rem; line-height: 1.5;">${resource.description}</p>` : ''}
                                </div>
                                ${hasUrl ? `<a href="${resource.url}" target="_blank" class="btn-f teal" style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.4rem 0.8rem; font-size: 0.85rem; text-decoration: none;">View Resource</a>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (videos.length > 0) {
                    html += '<h4 style="margin-top: 2rem;">Videos</h4>';
                    html += '<div class="video-playlist" style="margin-top: 1rem;">';
                    videos.forEach(video => {
                        const durationText = video.duration ? ` (${video.duration})` : '';
                        const embedUrl = getVideoEmbedUrl(video.url);

                        html += `
                            <div class="playlist-item" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong>${video.title}${durationText}</strong>
                                ${embedUrl ? `
                                    <div style="margin-top: 1rem; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                                        <iframe src="${embedUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                ` : `
                                    <div style="margin-top: 0.5rem; display: flex; justify-content: flex-end;">
                                        <a href="${video.url}" target="_blank" class="btn-f teal" style="padding: 0.5rem 1rem; font-size: 0.9rem; text-decoration: none;">View Resource</a>
                                    </div>
                                `}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            html += '</div>';
            container.innerHTML = html;
        }

        async function postDiscussion(questionIndex) {
            const textarea = document.getElementById(`response-${questionIndex}`);
            const content = textarea.value.trim();

            if (!content) {
                alert('Please enter a response before posting.');
                return;
            }

            // Use logged-in user's name
            const author = currentUser.name || currentUser.email || 'Anonymous';

            // Add discussion post using DataService (isolated per module)
            const pageIndex = currentPage - 1; // Convert to 0-based index
            await dataService.addDiscussionPost(currentModuleId, currentWeek.id, pageIndex, questionIndex, {
                author: author,
                content: content
            });

            alert('Response posted successfully!');
            textarea.value = '';

            // Reload the page to show the new post
            await renderPage();
        }

        // Close all open edit/reply forms to keep UI clean
        function closeAllEditForms() {
            // Close all post edit forms
            document.querySelectorAll('[id^="post-edit-form-"]').forEach(form => {
                if (form.style.display !== 'none') {
                    const postId = form.id.replace('post-edit-form-', '');
                    const contentEl = document.getElementById(`post-content-${postId}`);
                    const actionsEl = document.getElementById(`post-actions-${postId}`);
                    if (contentEl) contentEl.style.display = 'block';
                    form.style.display = 'none';
                    if (actionsEl) actionsEl.style.display = 'flex';
                }
            });
            // Close all reply edit forms
            document.querySelectorAll('[id^="reply-edit-form-"]').forEach(form => {
                if (form.style.display !== 'none') {
                    const replyId = form.id.replace('reply-edit-form-', '');
                    const contentEl = document.getElementById(`reply-content-${replyId}`);
                    const actionsEl = document.getElementById(`reply-actions-${replyId}`);
                    if (contentEl) contentEl.style.display = 'block';
                    form.style.display = 'none';
                    if (actionsEl) actionsEl.style.display = 'flex';
                }
            });
            // Close all reply forms (new reply)
            document.querySelectorAll('[id^="reply-form-"]').forEach(form => {
                form.style.display = 'none';
            });
        }

        function toggleReplyForm(postId) {
            const replyForm = document.getElementById(`reply-form-${postId}`);
            const isCurrentlyOpen = replyForm.style.display !== 'none';

            // Close all other forms first
            closeAllEditForms();

            // Toggle this one (if it was open, it's now closed; if closed, open it)
            if (!isCurrentlyOpen) {
                replyForm.style.display = 'block';
            }
        }

        async function postReply(pageIndex, questionIndex, postId) {
            const textarea = document.getElementById(`reply-text-${postId}`);
            const content = textarea.value.trim();

            if (!content) {
                alert('Please enter a reply before posting.');
                return;
            }

            // Use logged-in user's name
            const author = currentUser.name || currentUser.email || 'Anonymous';

            // Add reply using DataService (isolated per module)
            await dataService.addReply(currentModuleId, currentWeek.id, pageIndex, questionIndex, postId, {
                author: author,
                content: content
            });

            alert('Reply posted successfully!');

            // Reload the page to show the new reply
            await renderPage();
        }

        function editPost(postId) {
            // Close all other edit/reply forms first
            closeAllEditForms();

            document.getElementById(`post-content-${postId}`).style.display = 'none';
            document.getElementById(`post-edit-form-${postId}`).style.display = 'block';
            const actionsEl = document.getElementById(`post-actions-${postId}`);
            if (actionsEl) actionsEl.style.display = 'none';
        }

        function cancelPostEdit(postId) {
            document.getElementById(`post-content-${postId}`).style.display = 'block';
            document.getElementById(`post-edit-form-${postId}`).style.display = 'none';
            const actionsEl = document.getElementById(`post-actions-${postId}`);
            if (actionsEl) actionsEl.style.display = 'flex';
        }

        async function savePostEdit(pageIndex, questionIndex, postId) {
            const textarea = document.getElementById(`post-edit-text-${postId}`);
            const content = textarea.value.trim();

            if (!content) {
                alert('Post content cannot be empty.');
                return;
            }

            await dataService.editDiscussionPost(currentModuleId, currentWeek.id, pageIndex, questionIndex, postId, content);
            alert('Post updated successfully!');
            await renderPage();
        }

        function editReply(replyId) {
            // Close all other edit/reply forms first
            closeAllEditForms();

            document.getElementById(`reply-content-${replyId}`).style.display = 'none';
            document.getElementById(`reply-edit-form-${replyId}`).style.display = 'block';
            const actionsEl = document.getElementById(`reply-actions-${replyId}`);
            if (actionsEl) actionsEl.style.display = 'none';
        }

        function cancelReplyEdit(replyId) {
            document.getElementById(`reply-content-${replyId}`).style.display = 'block';
            document.getElementById(`reply-edit-form-${replyId}`).style.display = 'none';
            const actionsEl = document.getElementById(`reply-actions-${replyId}`);
            if (actionsEl) actionsEl.style.display = 'flex';
        }

        async function saveReplyEdit(pageIndex, questionIndex, postId, replyId) {
            const textarea = document.getElementById(`reply-edit-text-${replyId}`);
            const content = textarea.value.trim();

            if (!content) {
                alert('Reply content cannot be empty.');
                return;
            }

            await dataService.editReply(currentModuleId, currentWeek.id, pageIndex, questionIndex, postId, replyId, content);
            alert('Reply updated successfully!');
            await renderPage();
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? All replies will also be deleted.')) {
                return;
            }

            try {
                await dataService.deleteDiscussionPost(postId);
                await renderPage();
            } catch (err) {
                alert('Failed to delete post: ' + err.message);
            }
        }

        async function deleteReply(replyId) {
            if (!confirm('Are you sure you want to delete this reply?')) {
                return;
            }

            try {
                await dataService.deleteReply(replyId);
                await renderPage();
            } catch (err) {
                alert('Failed to delete reply: ' + err.message);
            }
        }

        // Helper to get week viewer URL (preserves participant mode)
        function getWeekViewerUrl(weekId, page) {
            const participantParam = isParticipantMode ? '&participant=true' : '';
            return `week-viewer.html?week=${weekId}&page=${page}${participantParam}`;
        }

        async function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                // Auto-save position for students
                if (currentView === 'student' && currentModuleId) {
                    await dataService.savePagePosition(currentModuleId, currentWeek.id, currentPage);
                }
                window.location.href = getWeekViewerUrl(currentWeek.id, currentPage);
            }
        }

        async function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                // Auto-save position for students
                if (currentView === 'student' && currentModuleId) {
                    await dataService.savePagePosition(currentModuleId, currentWeek.id, currentPage);
                }
                window.location.href = getWeekViewerUrl(currentWeek.id, currentPage);
            } else {
                // Finish - mark week as completed for students, just navigate for admins
                const currentView = dataService.getCurrentView();
                if (currentView === 'student' && currentModuleId) {
                    await dataService.completeWeek(currentModuleId, currentWeek.id);
                    alert('Week completed!');
                }
                window.location.href = getModuleOverviewUrl();
            }
        }

        // Save progress when user leaves page (sync version for unload events)
        function saveProgressOnExit() {
            // Note: beforeunload cannot use async/await reliably
            // Progress is saved on each page navigation, so this is just a backup
            if (currentView === 'student' && currentModuleId && currentWeek) {
                // Use sendBeacon for reliable async save on unload if needed
                // For now, main progress saving happens on explicit navigation
            }
        }

        // Helper to get module overview URL (preserves participant mode)
        function getModuleOverviewUrl() {
            return isParticipantMode ? 'module-overview.html?participant=true' : 'module-overview.html';
        }

        // Navigate back to module overview
        function goToModuleOverview() {
            window.location.href = getModuleOverviewUrl();
        }

        // Explicit save and exit button handler
        async function saveProgressAndExit() {
            if (currentModuleId && currentWeek) {
                await dataService.savePagePosition(currentModuleId, currentWeek.id, currentPage);
            }
            alert('Progress saved! You can resume from this page next time.');
            window.location.href = getModuleOverviewUrl();
        }

        // Check for saved position and offer to resume
        async function checkForSavedPosition() {
            if (currentView !== 'student' || !currentModuleId || !currentWeek) return;

            // Don't prompt to resume if the week is already completed
            const isCompleted = await dataService.isWeekCompleted(currentModuleId, currentWeek.id);
            if (isCompleted) return;

            const savedPosition = await dataService.getPagePosition(currentModuleId, currentWeek.id);
            const urlPage = getPageFromURL();

            // Only prompt if there's a saved position different from current page
            // and the user didn't explicitly navigate to a specific page
            if (savedPosition && savedPosition.page > 1 && urlPage === 1 && savedPosition.page !== currentPage) {
                const resume = confirm(`You left off on page ${savedPosition.page} of ${totalPages}. Would you like to resume from there?`);
                if (resume) {
                    currentPage = savedPosition.page;
                    window.location.href = getWeekViewerUrl(currentWeek.id, currentPage);
                }
            }
        }

        // Show content and hide loading spinner
        function showContent() {
            const loadingState = document.getElementById('loading-state');
            const mainContent = document.getElementById('main-content');

            loadingState.style.display = 'none';
            mainContent.classList.remove('page-loading');
            mainContent.classList.add('page-loaded');
        }

        // Show error and hide loading spinner
        function showError(message) {
            const loadingState = document.getElementById('loading-state');
            loadingState.innerHTML = `<p style="text-align: center; color: #dc3545; padding: 2rem;">${message}</p>`;
        }

        window.onload = async function() {
            // Auth guard
            currentUser = await requireActiveUser();
            if (!currentUser) return;

            // Render user header
            renderUserHeader();

            // Check module access
            currentModuleId = dataService.getCurrentModuleId();
            if (currentModuleId && currentUser.role !== 'admin') {
                const hasAccess = await canAccessModule(currentUser, currentModuleId);
                if (!hasAccess) {
                    alert('You do not have access to this module.');
                    window.location.href = 'index.html';
                    return;
                }
            }

            // Check for participant mode
            const urlParams = new URLSearchParams(window.location.search);
            isParticipantMode = urlParams.get('participant') === 'true';

            // Determine view based on user role
            let savedView;
            if (currentUser.role === 'admin' && !isParticipantMode) {
                savedView = 'admin';
            } else {
                savedView = 'student';
            }

            // In participant mode, show banner
            if (isParticipantMode) {
                showParticipantModeBanner();
            }

            await setView(savedView);
            try {
                if (await loadWeekData()) {
                    await renderPage();
                    // Show content after everything is loaded
                    showContent();
                    // Check for saved position after loading
                    try {
                        await checkForSavedPosition();
                    } catch (posErr) {
                        console.error('Error checking saved position:', posErr);
                        // Non-fatal, continue
                    }
                } else {
                    showError('Week not found.');
                }
            } catch (err) {
                console.error('Error loading week:', err);
                showError(`Error loading week: ${err.message}`);
            }
        };

        function showParticipantModeBanner() {
            const banner = document.createElement('div');
            banner.id = 'participant-mode-banner';
            banner.style.cssText = 'background: rgba(16, 100, 112, 0.15); color: #106470; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(16, 100, 112, 0.3);';
            banner.innerHTML = `
                <span style="font-family: \'Adobe Garamond Pro\', Georgia, serif; font-size: 1.05rem;"><strong>Participant Mode</strong> - You are viewing this module as a participant</span>
                <button class="btn-f teal" onclick="exitParticipantMode()">Exit to Admin View</button>
            `;
            const header = document.querySelector('header');
            header.insertAdjacentElement('afterend', banner);

            // Hide view toggle in participant mode
            const viewToggle = document.querySelector('.view-toggle');
            if (viewToggle) {
                viewToggle.style.display = 'none';
            }
        }

        function exitParticipantMode() {
            // Go back to module overview in admin view
            window.location.href = 'module-overview.html';
        }

        // Save progress when page is closed/navigated away
        window.addEventListener('beforeunload', saveProgressOnExit);
        window.addEventListener('pagehide', saveProgressOnExit);

        // Export functions to window for onclick handlers
        window.setView = setView;
        window.logoutUser = logout;
        window.exitParticipantMode = exitParticipantMode;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.goToModuleOverview = goToModuleOverview;
        window.saveProgressAndExit = saveProgressAndExit;
        window.postDiscussion = postDiscussion;
        window.toggleReplyForm = toggleReplyForm;
        window.postReply = postReply;
        window.editPost = editPost;
        window.cancelPostEdit = cancelPostEdit;
        window.savePostEdit = savePostEdit;
        window.editReply = editReply;
        window.cancelReplyEdit = cancelReplyEdit;
        window.saveReplyEdit = saveReplyEdit;
        window.deletePost = deletePost;
        window.deleteReply = deleteReply;
        window.dataService = dataService;
    </script>
</body>
</html>
