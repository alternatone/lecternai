<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Overview - Lectern</title>
    <link rel="stylesheet" href="styles/lectern-core.css">
    <script src="js/db-schema.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/rich-text.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            font-size: 2rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            border: none;
            background: none;
        }

        .modal-close:hover {
            color: var(--primary-color);
        }

        body.modal-open {
            overflow: hidden;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(16, 100, 112, 0.08);
            border-bottom: 1px solid rgba(16, 100, 112, 0.2);
        }
        .user-header .user-info {
            flex: 1;
            font-family: 'Adobe Garamond Pro', Georgia, serif;
            font-size: 1.1rem;
            color: #106470;
        }
        .user-header .admin-badge {
            background: var(--teal);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-left: 0.5rem;
            font-family: 'Benton Sans', Arial, sans-serif;
        }
        /* Loading state styles */
        .page-loading {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .page-loaded {
            opacity: 1;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        .loading-spinner::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stacked Cards with Color Accents */
        .stacked-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .stacked-card-header {
            padding: 0.6rem 1rem;
            font-family: 'Adobe Garamond Pro', Georgia, serif;
            font-size: 0.85rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            border-bottom: none;
        }
        .stacked-card-header.teal-accent {
            background: rgba(16, 100, 112, 0.15);
            color: var(--teal);
        }
        .stacked-card-header.gold-accent {
            background: rgba(255, 194, 34, 0.15);
            color: #8b6914;
        }
        .stacked-card-body {
            padding: 1rem;
            font-weight: 400;
            font-size: 0.9rem;
            color: #212529;
            line-height: 1.6;
        }

        /* Module Weeks - Simple Dividers */
        .divided-week {
            padding: 1.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .divided-week:last-child {
            border-bottom: none;
        }
        .divided-week-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        .divided-week-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            margin-top: 1.1rem;
        }
        .divided-week-label {
            font-family: 'Adobe Garamond Pro', Georgia, serif;
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #8b6914;
            margin-bottom: 0.25rem;
        }
        .divided-week h5 {
            margin: 0;
            font-size: 1.05rem;
        }
        .divided-week .meta {
            font-size: 0.8rem;
            color: var(--teal);
        }
        .divided-week p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.7;
        }

        /* Status Badges - Transparent Background Pills */
        .status-badge {
            padding: 0.4rem 0.9rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }
        .status-badge.in-progress {
            background: rgba(255, 194, 34, 0.12);
            color: #8b6914;
        }
        .status-badge.not-started {
            background: rgba(162, 31, 53, 0.12);
            color: #a21f35;
        }
        .status-badge.completed {
            background: rgba(40, 167, 69, 0.12);
            color: #1e7e34;
        }

        /* Create Week Modal - Page Sections with Bottom Border */
        .page-section {
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .page-section::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: #d1d5db;
        }

        .page-section:last-of-type::after {
            display: none;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .page-title {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 2rem;
        }

        .module-status-tag {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            vertical-align: middle;
            margin-left: 0.75rem;
            font-family: 'Benton Sans', Arial, sans-serif;
        }

        .module-status-tag.active {
            background: rgba(16, 100, 112, 0.12);
            color: #106470;
        }

        .module-status-tag.template {
            background: rgba(255, 194, 34, 0.12);
            color: #8b6914;
        }

        .module-status-tag.archived {
            background: rgba(138, 139, 140, 0.12);
            color: #6b6c6d;
        }
    </style>
</head>
<body>
    <div id="user-header" class="user-header" style="display: none;"></div>

    <header>
        <div class="header-content">
            <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                <img src="brand-assets/aquinas-logo.svg" alt="Aquinas Institute" class="logo-icon">
                <h1>Lectern</h1>
            </a>
            <div id="header-actions"></div>
        </div>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="container">
        <div class="loading-spinner">Loading module...</div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="main-content" class="container page-loading">
        <div class="breadcrumb">
            <a href="index.html">Home</a>
            <span>›</span>
            <span id="breadcrumb-module-name">Module</span>
        </div>

        <h2 class="page-title">
            <span id="module-title">Module Overview</span>
        </h2>

        <div class="section-panel teal-outline">
            <h3 class="teal-title">Module Info</h3>

            <div class="stacked-card">
                <div class="stacked-card-header teal-accent">Overview</div>
                <div class="stacked-card-body" id="module-description"></div>
            </div>

            <div class="stacked-card">
                <div class="stacked-card-header teal-accent">Course Details</div>
                <div class="stacked-card-body">
                    <p style="margin: 0.25rem 0;"><strong>Instructor:</strong> <span id="module-instructor"></span></p>
                    <p style="margin: 0.25rem 0;"><strong>Duration:</strong> <span id="module-duration"></span></p>
                </div>
            </div>

            <div id="zoom-info-display" class="stacked-card" style="display: none;">
                <div class="stacked-card-header gold-accent">Zoom Meeting</div>
                <div class="stacked-card-body">
                    <p id="zoom-display-day-time" style="margin: 0 0 0.25rem 0;"></p>
                    <p id="zoom-display-id" style="margin: 0 0 0.25rem 0;"></p>
                    <div id="zoom-display-url" style="margin-top: 0.75rem;"></div>
                </div>
            </div>

            <div id="additional-info" style="display: none;">
                <div class="stacked-card">
                    <div class="stacked-card-header teal-accent">Participation Requirements</div>
                    <div class="stacked-card-body" id="participation-requirements"></div>
                </div>

                <div class="stacked-card">
                    <div class="stacked-card-header teal-accent">Time Expectations</div>
                    <div class="stacked-card-body" id="time-expectations"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button id="edit-description-btn" class="btn-f gold" style="display: none; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="openEditDescriptionModal()">Edit Module Info</button>
            </div>
        </div>

        <div class="section-panel gold-outline">
            <h3 class="gold-title">Module Weeks</h3>
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button id="create-week-btn" class="btn-f gold" style="display: none; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="openCreateWeekModal()">+ New Week</button>
            </div>
            <div id="draft-week-notice" style="display: none; background: rgba(255, 194, 34, 0.15); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #8b6914;">Draft: <span id="draft-week-name">Untitled Week</span></strong>
                        <p style="margin: 0.5rem 0 0 0; color: #8b6914; font-size: 0.9rem;">You have an unsaved week draft</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-f gold" onclick="resumeDraft()" style="padding: 0.4rem 1rem; font-size: 0.9rem;">Resume</button>
                        <button class="btn-f olive" onclick="discardDraft()" style="padding: 0.4rem 1rem; font-size: 0.9rem;">Discard</button>
                    </div>
                </div>
            </div>
            <div id="weeks-list">
                <!-- Weeks will be populated by JavaScript -->
            </div>
        </div>

        <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <a href="index.html" class="btn-f olive" style="line-height: 1.5;">← Back to Modules</a>
            <div id="admin-action-btns" style="display: none; gap: 1rem;">
                <!-- For LAUNCHED modules: Save Changes button -->
                <button id="save-active-module-btn" class="btn-f teal" style="line-height: 1.5; display: none;" onclick="saveActiveModule()">Save Changes to Active Module</button>
                <!-- For DRAFT/TEMPLATE modules: Save Template and Launch buttons -->
                <button id="save-template-btn" class="btn-f gold" style="line-height: 1.5;" onclick="saveModuleProgress()">Save Template</button>
                <button id="launch-module-btn" class="btn-f teal" style="line-height: 1.5;" onclick="launchModule()">Launch Module</button>
                <!-- For DRAFT/TEMPLATE modules: Update Active Modules button -->
                <button id="update-active-modules-btn" class="btn-f olive" style="line-height: 1.5; display: none;" onclick="openUpdateActiveModulesModal()">Update Active Modules</button>
            </div>
        </div>
    </div><!-- end main-content -->

    <img src="brand-assets/aquinas-seal.svg" alt="" class="decorative-cross">

    <!-- Edit Description Modal -->
    <div id="edit-description-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Module Information</h3>
                <button class="modal-close" onclick="closeEditDescriptionModal()">&times;</button>
            </div>
            <div class="form-group" id="title-input-group" style="display: none;">
                <label for="title-input">Module Title</label>
                <input type="text" id="title-input">
                <small style="color: #6c757d;">Change the title for this active module section</small>
            </div>
            <div class="form-group">
                <label for="description-input">Module Overview</label>
                <textarea id="description-input" style="min-height: 150px;"></textarea>
            </div>
            <div class="form-group">
                <label for="instructor-input">Instructor</label>
                <input type="text" id="instructor-input">
            </div>
            <div class="form-group">
                <label for="duration-input">Duration</label>
                <input type="text" id="duration-input">
            </div>
            <div class="form-group">
                <label for="participation-input">Participation Requirements</label>
                <textarea id="participation-input" style="min-height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label for="time-input">Time Expectations</label>
                <textarea id="time-input" style="min-height: 80px;"></textarea>
            </div>
            <hr style="margin: 2rem 0;">
            <h4 style="margin-bottom: 1rem;">Zoom Meeting Setup</h4>
            <div class="form-group">
                <label for="zoom-url-input">Zoom Meeting URL</label>
                <input type="text" id="zoom-url-input">
            </div>
            <div class="form-group">
                <label for="zoom-id-input">Meeting ID</label>
                <input type="text" id="zoom-id-input">
            </div>
            <div class="form-group">
                <label for="zoom-passcode-input">Passcode</label>
                <input type="text" id="zoom-passcode-input">
            </div>
            <div class="form-group">
                <label for="zoom-day-input">Weekly Meeting Day</label>
                <select id="zoom-day-input">
                    <option value="">Select a day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div class="form-group">
                <label for="zoom-time-input">Meeting Time</label>
                <input type="time" id="zoom-time-input">
            </div>
            <div class="form-group">
                <label for="zoom-timezone-input">Timezone</label>
                <select id="zoom-timezone-input">
                    <option value="EST">Eastern (EST/EDT)</option>
                    <option value="CST">Central (CST/CDT)</option>
                    <option value="MST">Mountain (MST/MDT)</option>
                    <option value="PST">Pacific (PST/PDT)</option>
                    <option value="UTC">UTC</option>
                </select>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeEditDescriptionModal()">Cancel</button>
                <button class="btn-f teal" onclick="saveDescription()">Save & Close</button>
            </div>
        </div>
    </div>

    <!-- Create Week Modal -->
    <div id="create-week-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Create New Week</h3>
                <button class="modal-close" onclick="closeCreateWeekModal()">&times;</button>
            </div>

            <div class="form-group">
                <label for="week-title-input">Week Title</label>
                <input type="text" id="week-title-input">
            </div>

            <div class="form-group">
                <label for="week-description-input">Week Description</label>
                <textarea id="week-description-input" style="min-height: 80px;"></textarea>
            </div>

            <div class="form-group">
                <label for="week-unlock-date-input">Unlock Date <span style="color: var(--primary-color);">*</span></label>
                <input type="date" id="week-unlock-date-input" required>
                <small style="color: #6c757d; margin-top: 0.25rem; display: block;">Required. This date determines when students can access this week.</small>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 1: Opening Reflection Question</h4>
                    <button class="btn-f gold" onclick="openAddPage1QuestionModal()">+ Add Question</button>
                </div>
                <div id="page1-questions-list">
                    <!-- Questions will be populated here -->
                </div>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 2: Intro to the Week</h4>
                    <button class="btn-f gold" onclick="openAddResourceModal('intro')">+ Add Resource</button>
                </div>
                <div class="form-group">
                    <label for="page2-intro-text">Week Introduction</label>
                    <textarea id="page2-intro-text" style="min-height: 150px;"></textarea>
                </div>
                <div class="video-playlist" id="video-list" style="margin-top: 1rem;">
                    <!-- Videos will be populated here -->
                </div>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 3: Weekly Readings</h4>
                    <button class="btn-f gold" onclick="openAddResourceModal('readings')">+ Add Resource</button>
                </div>
                <div class="resource-list" id="weekly-readings-list">
                    <!-- Resources will be populated here -->
                </div>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 4: Preparation for Zoom Session</h4>
                </div>
                <div class="form-group">
                    <textarea id="zoom-prep-text" style="min-height: 120px;" placeholder="Enter instructions, agenda, or any preparation content for the upcoming Zoom session..."></textarea>
                </div>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 5: Post-Zoom Reflection</h4>
                    <button class="btn-f gold" onclick="openAddQuestionModal()">+ Add Question</button>
                </div>
                <div id="reflection-questions-list">
                    <!-- Questions will be populated here -->
                </div>
            </div>

            <div class="page-section">
                <div class="page-header">
                    <h4 class="page-title">Page 6: Further Study</h4>
                    <button class="btn-f gold" onclick="openAddResourceModal('furtherStudy')">+ Add Resource</button>
                </div>
                <div class="resource-list" id="further-study-list">
                    <!-- Further study resources will be populated here -->
                </div>
                <div class="video-playlist" id="page5-video-list" style="margin-top: 1rem;">
                    <!-- Page 5 videos will be populated here -->
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeCreateWeekModal()">Cancel</button>
                <button class="btn-f olive" onclick="saveWeekAsDraft()">Save as Draft</button>
                <button class="btn-f teal" onclick="saveNewWeek()">Create Week</button>
            </div>
        </div>
    </div>

    <!-- Add Resource Modal (supports both documents and videos) -->
    <div id="add-resource-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="resource-modal-title">Add Resource</h3>
                <button class="modal-close" onclick="closeAddResourceModal()">&times;</button>
            </div>
            <input type="hidden" id="resource-target-type" value="readings">
            <div class="form-group">
                <label for="resource-title">Title</label>
                <input type="text" id="resource-title">
            </div>
            <div class="form-group">
                <label for="resource-url">URL (Optional)</label>
                <input type="text" id="resource-url" oninput="checkResourceUrl()">
                <small style="color: #6c757d; margin-top: 0.5rem; display: block;">Videos (YouTube, Vimeo) will be embedded. Other links will open in a new tab.</small>
            </div>
            <div class="form-group" id="resource-duration-group" style="display: none;">
                <label for="resource-duration">Duration (Optional)</label>
                <input type="text" id="resource-duration" placeholder="e.g., 12:45">
            </div>
            <div class="form-group">
                <label for="resource-description">Description (Optional)</label>
                <textarea id="resource-description"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeAddResourceModal()">Cancel</button>
                <button class="btn-f teal" onclick="addResource()">Add Resource</button>
            </div>
        </div>
    </div>

    <!-- Edit Resource Modal -->
    <div id="edit-resource-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Resource</h3>
                <button class="modal-close" onclick="closeEditResourceModal()">&times;</button>
            </div>
            <input type="hidden" id="edit-resource-id">
            <input type="hidden" id="edit-resource-type">
            <div class="form-group">
                <label for="edit-resource-title">Resource Title</label>
                <input type="text" id="edit-resource-title">
            </div>
            <div class="form-group">
                <label for="edit-resource-url">URL (Optional)</label>
                <input type="text" id="edit-resource-url">
            </div>
            <div class="form-group">
                <label for="edit-resource-description">Description (Optional)</label>
                <textarea id="edit-resource-description"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeEditResourceModal()">Cancel</button>
                <button class="btn-f teal" onclick="saveResourceEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Video Modal -->
    <div id="add-video-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="video-modal-title">Add Resource</h3>
                <button class="modal-close" onclick="closeAddVideoModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="video-title">Title</label>
                <input type="text" id="video-title">
            </div>
            <div class="form-group">
                <label for="video-url">URL</label>
                <input type="text" id="video-url">
                <small style="color: #6c757d; margin-top: 0.5rem; display: block;">Supported: YouTube, Vimeo, or direct video file URLs</small>
            </div>
            <div class="form-group">
                <label for="video-duration">Duration (Optional)</label>
                <input type="text" id="video-duration">
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeAddVideoModal()">Cancel</button>
                <button class="btn-f teal" id="video-modal-submit-btn" onclick="addVideo()">Add Resource</button>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="add-question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="question-modal-title">Add Question</h3>
                <button class="modal-close" onclick="closeAddQuestionModal()">&times;</button>
            </div>
            <div class="form-group">
                <textarea id="question-text" placeholder="Enter your question..." style="min-height: 120px;"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeAddQuestionModal()">Cancel</button>
                <button class="btn-f teal" id="question-modal-submit-btn" onclick="addQuestion()">Add Question</button>
            </div>
        </div>
    </div>

    <!-- Update Active Modules Modal -->
    <div id="update-active-modules-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Update Active Modules</h3>
                <button class="modal-close" onclick="closeUpdateActiveModulesModal()">&times;</button>
            </div>
            <p style="color: #6c757d; margin-bottom: 1rem;">Select which active modules should receive changes from this template. Student discussions and progress will be preserved.</p>
            <div id="active-modules-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 0.5rem;">
                <div style="text-align: center; padding: 2rem; color: #6c757d;">Loading active modules...</div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-f olive" onclick="closeUpdateActiveModulesModal()">Cancel</button>
                <button class="btn-f teal" id="sync-selected-btn" onclick="syncSelectedModules()" disabled>Update Selected</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { dataService } from './js/data-service-supabase.js';
        import { requireActiveUser, logout, canAccessModule } from './js/auth.js';

        const weeks = [];
        let weeklyReadings = [];
        let furtherStudy = [];
        let videos = [];
        let page5Videos = [];
        let page1Questions = [];
        let reflectionQuestions = [];

        // Edit mode tracking
        let editingWeekId = null;
        let isEditMode = false;
        let editingWeekUpdatedAt = null;  // For optimistic locking

        // Participant mode - admin experiencing module as student
        let isParticipantMode = false;

        // Current authenticated user
        let currentUser = null;

        let currentView = 'student';

        // Helper to get/set content from both textareas and contenteditable divs
        function getFieldValue(id) {
            const el = document.getElementById(id);
            if (!el) return '';
            if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                return el.value.trim();
            }
            return el.innerHTML.trim();
        }

        function setFieldValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                el.value = value || '';
            } else {
                el.innerHTML = value || '';
            }
        }

        function renderUserHeader() {
            const header = document.getElementById('user-header');
            const isAdmin = currentUser.role === 'admin';

            header.innerHTML = `
                <span class="user-info">
                    <strong>${currentUser.name || currentUser.email}</strong>
                    ${isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                </span>
                ${isAdmin ? '<a href="admin-users.html" class="btn-f teal">Manage Users</a>' : ''}
                <button onclick="logoutUser()" class="btn-f olive">Logout</button>
            `;
            header.style.display = 'flex';
        }

        async function setView(view, fromToggle = false) {
            // Only redirect to index.html if explicitly toggling to student view (not on page load)
            if (view === 'student' && fromToggle) {
                dataService.setCurrentView('student');
                window.location.href = 'index.html';
                return;
            }

            currentView = view;

            if (view === 'student') {
                dataService.setCurrentView('student');
                // Hide admin controls in student view
                document.getElementById('edit-description-btn').style.display = 'none';
                document.getElementById('create-week-btn').style.display = 'none';
                document.getElementById('admin-action-btns').style.display = 'none';
            } else {
                dataService.setCurrentView('admin');
                // Show admin controls
                document.getElementById('edit-description-btn').style.display = 'inline-block';
                document.getElementById('create-week-btn').style.display = 'inline-block';
                document.getElementById('admin-action-btns').style.display = 'flex';

                // Show/hide buttons based on module status
                const currentModuleId = dataService.getCurrentModuleId();
                const currentModule = currentModuleId ? await dataService.getModule(currentModuleId) : null;

                if (currentModule && currentModule.status === 'launched') {
                    // Launched/Active module: show Save Changes button, hide Launch/Save Template/Update Active buttons
                    document.getElementById('launch-module-btn').style.display = 'none';
                    document.getElementById('save-template-btn').style.display = 'none';
                    document.getElementById('update-active-modules-btn').style.display = 'none';
                    document.getElementById('save-active-module-btn').style.display = 'inline-block';
                } else {
                    // Draft/template module: show Launch/Save Template buttons, and Update Active Modules button
                    document.getElementById('launch-module-btn').style.display = 'inline-block';
                    document.getElementById('save-template-btn').style.display = 'inline-block';
                    document.getElementById('update-active-modules-btn').style.display = 'inline-block';
                    document.getElementById('save-active-module-btn').style.display = 'none';
                }

                checkForDraft();
            }

            await renderWeeks();
        }

        async function renderWeeks() {
            const weeksList = document.getElementById('weeks-list');
            weeksList.innerHTML = '';

            if (weeks.length === 0) {
                weeksList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No weeks created yet.</p>';
                return;
            }

            const currentModuleId = dataService.getCurrentModuleId();
            const today = new Date().toISOString().split('T')[0];

            // Batch fetch progress for all weeks (single query instead of 2N queries)
            const progressMap = currentView === 'student' ?
                await dataService.getBatchWeekProgress(currentModuleId) : {};

            for (const week of weeks) {
                // Check if week is locked for students
                const isLocked = currentView === 'student' && (
                    (week.unlockDate && week.unlockDate > today) ||
                    (week.status === 'locked' && !week.unlockDate)
                );

                const weekItem = document.createElement('div');
                weekItem.className = 'divided-week';

                // Parse date as local timezone to avoid off-by-one day issue
                const formatUnlockDate = (dateStr) => {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    return new Date(year, month - 1, day).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                };

                // Determine meta text (unlock status)
                let metaHtml = '';
                if (currentView === 'admin' && week.unlockDate) {
                    if (week.unlockDate <= today) {
                        metaHtml = '<div class="meta">Available now</div>';
                    } else {
                        metaHtml = `<div class="meta" style="color: #8b6914;">Unlocks ${formatUnlockDate(week.unlockDate)}</div>`;
                    }
                } else if (currentView === 'student') {
                    if (isLocked && week.unlockDate) {
                        metaHtml = `<div class="meta" style="color: #8b6914;">Unlocks ${formatUnlockDate(week.unlockDate)}</div>`;
                    } else if (isLocked) {
                        metaHtml = '<div class="meta" style="color: #8b6914;">Locked</div>';
                    } else {
                        metaHtml = '<div class="meta">Available now</div>';
                    }
                }

                // Use batch-fetched progress data (no additional queries)
                const weekProgress = progressMap[week.id] || {};
                const hasProgress = weekProgress.page;
                const isComplete = weekProgress.completed;

                // Build week viewer URL (include participant param if in participant mode)
                const weekViewerUrl = `week-viewer.html?week=${week.id}&page=1${isParticipantMode ? '&participant=true' : ''}`;

                let actionsHtml = '';
                if (currentView === 'admin' && !isParticipantMode) {
                    // Admin view: Show Preview, Edit, and Delete buttons
                    actionsHtml = `
                        <div class="divided-week-actions">
                            <button class="btn-f olive" type="button" onclick="location.href='week-viewer.html?week=${week.id}&page=1&preview=true'" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Preview</button>
                            <button class="btn-f gold" type="button" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;" onclick="openEditWeekModal(${week.id})">Edit</button>
                            <button class="btn-f red" type="button" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;" onclick="deleteWeek(${week.id})">Delete</button>
                        </div>
                    `;
                } else {
                    // Student view (or participant mode): Show status and View Week button
                    let statusBadge = '';
                    if (isLocked) {
                        statusBadge = '<span class="status-badge locked" style="background: #e9ecef; color: #6c757d;">Locked</span>';
                        actionsHtml = `
                            <div class="divided-week-actions">
                                ${statusBadge}
                                <button class="btn-f olive" type="button" disabled style="padding: 0.4rem 0.8rem; font-size: 0.9rem; opacity: 0.5; cursor: not-allowed;">View Week</button>
                            </div>
                        `;
                    } else {
                        if (week.status === 'complete' || isComplete) {
                            statusBadge = '<span class="status-badge completed">Completed</span>';
                        } else {
                            const statusText = hasProgress && !isComplete ? 'In Progress' : 'Not Started';
                            const statusClass = hasProgress && !isComplete ? 'in-progress' : 'not-started';
                            statusBadge = `<span class="status-badge ${statusClass}">${statusText}</span>`;
                        }
                        actionsHtml = `
                            <div class="divided-week-actions">
                                ${statusBadge}
                                <button class="btn-f olive" type="button" onclick="location.href='${weekViewerUrl}'" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">View Week</button>
                            </div>
                        `;
                    }
                }

                weekItem.innerHTML = `
                    <div class="divided-week-header">
                        <div>
                            <div class="divided-week-label">Week ${week.id}</div>
                            <h5>${week.title}</h5>
                            ${metaHtml}
                        </div>
                        ${actionsHtml}
                    </div>
                    <p>${formatText(week.description || '')}</p>
                `;

                weeksList.appendChild(weekItem);
            }

            // If student view and no visible weeks, show message
            if (currentView === 'student' && weeksList.children.length === 0) {
                weeksList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No weeks available yet. Check back later!</p>';
            }
        }

        async function openEditDescriptionModal() {
            // Load module info using DataService
            const currentModuleId = dataService.getCurrentModuleId();
            const currentModule = currentModuleId ? await dataService.getModule(currentModuleId) : {};

            // Show title field only for active (launched) modules
            const titleInputGroup = document.getElementById('title-input-group');
            if (currentModule.status === 'launched') {
                titleInputGroup.style.display = 'block';
                document.getElementById('title-input').value = currentModule.title || '';
            } else {
                titleInputGroup.style.display = 'none';
            }

            setFieldValue('description-input', currentModule.description || '');
            document.getElementById('instructor-input').value = currentModule.instructor || '';
            document.getElementById('duration-input').value = currentModule.duration || '';
            setFieldValue('participation-input', currentModule.participation || '');
            setFieldValue('time-input', currentModule.timeExpectations || '');

            // Load zoom info using DataService
            const zoomInfo = currentModuleId ? await dataService.getZoomInfo(currentModuleId) : {};
            document.getElementById('zoom-url-input').value = zoomInfo.url || '';
            document.getElementById('zoom-id-input').value = zoomInfo.meetingId || '';
            document.getElementById('zoom-passcode-input').value = zoomInfo.passcode || '';
            document.getElementById('zoom-day-input').value = (zoomInfo.schedule && zoomInfo.schedule.day) || '';
            document.getElementById('zoom-time-input').value = (zoomInfo.schedule && zoomInfo.schedule.time) || '';
            document.getElementById('zoom-timezone-input').value = (zoomInfo.schedule && zoomInfo.schedule.timezone) || 'EST';

            // Load any unsaved draft
            loadModuleInfoDraft();

            // Reset save button state
            const saveBtn = document.querySelector('#edit-description-modal .btn-f.teal');
            if (saveBtn) {
                saveBtn.textContent = 'Save & Close';
                saveBtn.disabled = false;
            }

            document.getElementById('edit-description-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function closeEditDescriptionModal() {
            document.getElementById('edit-description-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
        }

        async function saveDescription() {
            const description = getFieldValue('description-input');
            const instructor = document.getElementById('instructor-input').value;
            const duration = document.getElementById('duration-input').value;
            const participation = getFieldValue('participation-input');
            const timeExp = getFieldValue('time-input');

            // Get current module and update using DataService
            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.querySelector('#edit-description-modal .btn-f.teal');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            const updates = {
                description: description,
                instructor: instructor,
                duration: duration,
                participation: participation,
                timeExpectations: timeExp
                // Keep status unchanged - templates remain 'draft' until launched
            };

            // Include title for active modules
            const titleInputGroup = document.getElementById('title-input-group');
            if (titleInputGroup.style.display !== 'none') {
                updates.title = document.getElementById('title-input').value;
            }

            try {
                const result = await dataService.updateModule(currentModuleId, updates);

                if (!result.success) {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    showNotification(result.message || 'Failed to save module', 'error');
                    return;
                }

                // Save zoom info using DataService
                const zoomInfo = {
                    url: document.getElementById('zoom-url-input').value,
                    meetingId: document.getElementById('zoom-id-input').value,
                    passcode: document.getElementById('zoom-passcode-input').value,
                    schedule: {
                        day: document.getElementById('zoom-day-input').value,
                        time: document.getElementById('zoom-time-input').value,
                        timezone: document.getElementById('zoom-timezone-input').value
                    }
                };

                // Validate zoom info if provided
                if (zoomInfo.url || zoomInfo.meetingId) {
                    const validation = Validator.validateZoomInfo(zoomInfo);
                    if (!validation.valid) {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                        showNotification('Zoom validation errors: ' + validation.errors.join(', '), 'error');
                        return;
                    }
                }

                await dataService.updateZoomInfo(currentModuleId, zoomInfo);

                // Update UI with formatted text
                document.getElementById('module-description').innerHTML = formatText(description);
                document.getElementById('module-instructor').textContent = instructor;
                document.getElementById('module-duration').textContent = duration;
                document.getElementById('participation-requirements').innerHTML = formatText(participation);
                document.getElementById('time-expectations').innerHTML = formatText(timeExp);

                // Update title if it was edited (active modules only)
                if (updates.title) {
                    document.getElementById('module-title').textContent = updates.title;
                    // Also update breadcrumb
                    const breadcrumb = document.querySelector('.breadcrumb-item:last-child');
                    if (breadcrumb) breadcrumb.textContent = updates.title;
                }

                // Clear the draft since we successfully saved
                dataService.deleteDraft('moduleInfo');

                // Show additional info if any of the fields are filled
                if (participation || timeExp) {
                    document.getElementById('additional-info').style.display = 'block';
                } else {
                    document.getElementById('additional-info').style.display = 'none';
                }

                // Update zoom info display
                await displayZoomInfo();

                closeEditDescriptionModal();
                showNotification('Module information saved successfully!', 'success');
            } catch (error) {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                showNotification('Error saving module: ' + error.message, 'error');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                font-weight: 500;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                backdrop-filter: blur(10px);
            `;

            if (type === 'success') {
                notification.style.backgroundColor = 'rgba(16, 100, 112, 0.75)';
                notification.style.color = '#ffffff';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'rgba(139, 26, 26, 0.75)';
                notification.style.color = '#ffffff';
            } else {
                notification.style.backgroundColor = 'rgba(115, 125, 78, 0.75)';
                notification.style.color = '#ffffff';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 4000);
        }

        async function displayZoomInfo() {
            // Load zoom info using DataService
            const currentModuleId = dataService.getCurrentModuleId();
            const zoomInfo = currentModuleId ? await dataService.getZoomInfo(currentModuleId) : {};
            const displayDiv = document.getElementById('zoom-info-display');

            // Check if any zoom info exists
            if (!zoomInfo.url && !zoomInfo.meetingId && !(zoomInfo.schedule && zoomInfo.schedule.day)) {
                displayDiv.style.display = 'none';
                return;
            }

            // Show the display div and populate the data
            displayDiv.style.display = 'block';

            const dayTimeElement = document.getElementById('zoom-display-day-time');
            const idElement = document.getElementById('zoom-display-id');
            const urlElement = document.getElementById('zoom-display-url');

            // Format day and time
            if (zoomInfo.schedule && zoomInfo.schedule.day && zoomInfo.schedule.time) {
                const timezone = zoomInfo.schedule.timezone ? ` ${zoomInfo.schedule.timezone}` : '';
                dayTimeElement.textContent = `Day & Time: ${zoomInfo.schedule.day} at ${zoomInfo.schedule.time}${timezone}`;
            } else {
                dayTimeElement.textContent = '';
            }

            // Display meeting ID and passcode
            if (zoomInfo.meetingId) {
                const passcode = zoomInfo.passcode ? ` (Passcode: ${zoomInfo.passcode})` : '';
                idElement.textContent = `Meeting ID: ${zoomInfo.meetingId}${passcode}`;
            } else {
                idElement.textContent = '';
            }

            // Display URL as button
            if (zoomInfo.url) {
                urlElement.innerHTML = `<a href="${zoomInfo.url}" target="_blank" class="btn-f teal">Join Meeting</a>`;
            } else {
                urlElement.textContent = '';
            }
        }

        // Disable click-outside-to-close for modals to prevent accidental data loss
        // Users must explicitly click Cancel/Exit or Save buttons
        window.onclick = function(event) {
            // Intentionally disabled to prevent accidental closing
            // All modals now auto-save to localStorage
        }

        async function loadModuleInfo() {
            // Load module info using DataService
            const currentModuleId = dataService.getCurrentModuleId();
            let moduleInfo = {};

            if (currentModuleId) {
                const currentModule = await dataService.getModule(currentModuleId);

                if (currentModule) {
                    moduleInfo = {
                        description: currentModule.description || '',
                        instructor: currentModule.instructor || '',
                        duration: currentModule.duration || '',
                        participation: currentModule.participation || '',
                        timeExpectations: currentModule.timeExpectations || ''
                    };

                    // Update breadcrumb
                    const breadcrumbElement = document.querySelector('.breadcrumb span:last-child');
                    if (breadcrumbElement) {
                        breadcrumbElement.textContent = currentModule.title || 'Module';
                    }

                    // Update main page title with module name and status tag
                    const moduleTitleElement = document.getElementById('module-title');
                    if (moduleTitleElement) {
                        const moduleTitle = currentModule.title || 'Module Overview';
                        let statusTag = '';

                        if (currentModule.status === 'launched') {
                            statusTag = '<span class="module-status-tag active">Active</span>';
                        } else if (currentModule.status === 'archived') {
                            statusTag = '<span class="module-status-tag archived">Archived</span>';
                        } else {
                            // Draft/template
                            statusTag = '<span class="module-status-tag template">Template</span>';
                        }

                        moduleTitleElement.innerHTML = moduleTitle + statusTag;
                    }
                }
            }

            if (moduleInfo.description) {
                document.getElementById('module-description').innerHTML = formatText(moduleInfo.description);
            }
            if (moduleInfo.instructor) {
                document.getElementById('module-instructor').textContent = moduleInfo.instructor;
            }
            if (moduleInfo.duration) {
                document.getElementById('module-duration').textContent = moduleInfo.duration;
            }
            if (moduleInfo.participation) {
                document.getElementById('participation-requirements').innerHTML = formatText(moduleInfo.participation);
            }
            if (moduleInfo.timeExpectations) {
                document.getElementById('time-expectations').innerHTML = formatText(moduleInfo.timeExpectations);
            }

            // Show additional info if any of the fields are filled
            if (moduleInfo.participation || moduleInfo.timeExpectations) {
                document.getElementById('additional-info').style.display = 'block';
            }
        }

        function openCreateWeekModal() {
            // Reset edit mode
            isEditMode = false;
            editingWeekId = null;

            // Reset arrays
            weeklyReadings = [];
            furtherStudy = [];
            videos = [];
            page5Videos = [];
            page1Questions = [];
            reflectionQuestions = [];

            // Clear form fields
            document.getElementById('week-title-input').value = '';
            setFieldValue('week-description-input', '');
            document.getElementById('week-unlock-date-input').value = '';
            setFieldValue('page2-intro-text', '');
            setFieldValue('zoom-prep-text', '');

            renderWeeklyReadings();
            renderFurtherStudy();
            renderVideos();
            renderPage5Videos();
            renderPage1Questions();
            renderReflectionQuestions();

            // Update modal title and button text for create mode
            document.querySelector('#create-week-modal h3').textContent = 'Create New Week';
            const saveBtn = document.querySelector('#create-week-modal .btn-f.teal');
            saveBtn.textContent = 'Create Week';

            document.getElementById('create-week-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function closeCreateWeekModal() {
            document.getElementById('create-week-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
            // Reset edit mode
            isEditMode = false;
            editingWeekId = null;
            // Clear form
            document.getElementById('week-title-input').value = '';
            setFieldValue('week-description-input', '');
            document.getElementById('week-unlock-date-input').value = '';
            setFieldValue('page2-intro-text', '');
            setFieldValue('zoom-prep-text', '');
            weeklyReadings = [];
            furtherStudy = [];
            videos = [];
            page5Videos = [];
            page1Questions = [];
            reflectionQuestions = [];
        }

        async function openEditWeekModal(weekId) {
            // Set edit mode
            isEditMode = true;
            editingWeekId = weekId;

            // Find the week data
            const week = weeks.find(w => w.id === weekId);
            if (!week) {
                showNotification('Week not found', 'error');
                return;
            }

            // Store updated_at for optimistic locking (conflict detection)
            editingWeekUpdatedAt = week.updatedAt || week.updated_at || null;

            // Populate form fields
            document.getElementById('week-title-input').value = week.title || '';
            setFieldValue('week-description-input', week.description || '');
            document.getElementById('week-unlock-date-input').value = week.unlockDate || week.unlock_date || '';

            // Extract page data
            const pages = week.pages || [];

            // Page 1: Opening Reflection Questions
            const page1 = pages.find(p => p.title === 'Opening Reflection Question') || pages[0];
            page1Questions = page1?.questions || [];

            // Page 2: Introduction to the Week
            const page2 = pages.find(p => p.title === 'Introduction to the Week') || pages[1];
            setFieldValue('page2-intro-text', page2?.content || '');
            videos = page2?.videos || [];

            // Page 3: Weekly Reading
            const page3 = pages.find(p => p.title === 'Weekly Reading') || pages[2];
            weeklyReadings = page3?.resources || [];

            // Page 4: Preparation for Zoom Session
            const page4 = pages.find(p => p.title === 'Preparation for Zoom Session') || pages[3];
            setFieldValue('zoom-prep-text', page4?.content || '');

            // Page 5: Post-Zoom Reflection
            const page5 = pages.find(p => p.title === 'Post-Zoom Reflection') || pages[4];
            reflectionQuestions = page5?.questions || [];

            // Page 6: Further Study
            const page6 = pages.find(p => p.title === 'Further Study') || pages[5];
            furtherStudy = page6?.resources || [];
            page5Videos = page6?.videos || [];

            // Render all lists
            renderWeeklyReadings();
            renderFurtherStudy();
            renderVideos();
            renderPage5Videos();
            renderPage1Questions();
            renderReflectionQuestions();

            // Update modal title and button text for edit mode
            document.querySelector('#create-week-modal h3').textContent = 'Edit Week';
            const saveBtn = document.querySelector('#create-week-modal .btn-f.teal');
            saveBtn.textContent = 'Save Changes';

            document.getElementById('create-week-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function renderWeeklyReadings() {
            const list = document.getElementById('weekly-readings-list');
            list.innerHTML = '';
            if (weeklyReadings.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No resources added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            weeklyReadings.forEach(resource => {
                const item = document.createElement('div');
                item.className = 'resource-item';
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                item.innerHTML = `
                    <strong>${resource.title}</strong>
                    <p style="color: #6c757d; margin-top: 0.25rem;">${formatText(resource.description || 'No description')}</p>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editResource(${resource.id}, 'reading')">Edit</button>
                        <button class="btn-f red" onclick="deleteResource(${resource.id}, 'reading')">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        function renderFurtherStudy() {
            const list = document.getElementById('further-study-list');
            list.innerHTML = '';
            if (furtherStudy.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No resources added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            furtherStudy.forEach(resource => {
                const item = document.createElement('div');
                item.className = 'resource-item';
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                item.innerHTML = `
                    <strong>${resource.title}</strong>
                    <p style="color: #6c757d; margin-top: 0.25rem;">${formatText(resource.description || 'No description')}</p>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editResource(${resource.id}, 'study')">Edit</button>
                        <button class="btn-f red" onclick="deleteResource(${resource.id}, 'study')">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        // Check if URL is a video (YouTube or Vimeo)
        function isVideoUrl(url) {
            if (!url) return false;
            const videoPatterns = [
                /youtube\.com\/watch/i,
                /youtu\.be\//i,
                /youtube\.com\/embed/i,
                /vimeo\.com\//i
            ];
            return videoPatterns.some(pattern => pattern.test(url));
        }

        function checkResourceUrl() {
            const url = document.getElementById('resource-url').value;
            const durationGroup = document.getElementById('resource-duration-group');
            if (isVideoUrl(url)) {
                durationGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'none';
            }
        }

        function openAddResourceModal(targetType) {
            document.getElementById('resource-title').value = '';
            document.getElementById('resource-url').value = '';
            setFieldValue('resource-description', '');
            document.getElementById('resource-duration').value = '';
            document.getElementById('resource-duration-group').style.display = 'none';
            document.getElementById('resource-target-type').value = targetType || 'readings';
            document.getElementById('add-resource-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function closeAddResourceModal() {
            document.getElementById('add-resource-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
        }

        function addResource() {
            const title = document.getElementById('resource-title').value.trim();
            const url = document.getElementById('resource-url').value.trim();
            const description = getFieldValue('resource-description');
            const duration = document.getElementById('resource-duration').value.trim();
            const targetType = document.getElementById('resource-target-type').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            const newResource = {
                id: Date.now(),
                title: title,
                url: url,
                description: description
            };

            // Add duration if it's a video
            if (isVideoUrl(url) && duration) {
                newResource.duration = duration;
            }

            // Add to appropriate list based on target type
            switch (targetType) {
                case 'intro':
                    videos.push(newResource);
                    renderVideos();
                    break;
                case 'readings':
                    weeklyReadings.push(newResource);
                    renderWeeklyReadings();
                    break;
                case 'furtherStudy':
                    furtherStudy.push(newResource);
                    renderFurtherStudy();
                    break;
            }

            closeAddResourceModal();
            autoSaveCreateWeekDraft();
        }

        function editResource(id, type) {
            const list = type === 'reading' ? weeklyReadings : furtherStudy;
            const resource = list.find(r => r.id === id);
            if (resource) {
                document.getElementById('edit-resource-id').value = id;
                document.getElementById('edit-resource-type').value = type;
                document.getElementById('edit-resource-title').value = resource.title;
                document.getElementById('edit-resource-url').value = resource.url;
                setFieldValue('edit-resource-description', resource.description || '');
                document.getElementById('edit-resource-modal').style.display = 'block';
                document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
            }
        }

        function closeEditResourceModal() {
            document.getElementById('edit-resource-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
        }

        function saveResourceEdit() {
            const id = parseInt(document.getElementById('edit-resource-id').value);
            const type = document.getElementById('edit-resource-type').value;
            const title = document.getElementById('edit-resource-title').value.trim();
            const url = document.getElementById('edit-resource-url').value.trim();
            const description = getFieldValue('edit-resource-description');

            if (!title) {
                alert('Please enter a title');
                return;
            }

            const list = type === 'reading' ? weeklyReadings : furtherStudy;
            const resource = list.find(r => r.id === id);
            if (resource) {
                resource.title = title;
                resource.url = url;
                resource.description = description;

                if (type === 'reading') {
                    renderWeeklyReadings();
                } else {
                    renderFurtherStudy();
                }

                closeEditResourceModal();
            }
        }

        function deleteResource(id, type) {
            if (confirm('Are you sure you want to delete this resource?')) {
                if (type === 'reading') {
                    weeklyReadings = weeklyReadings.filter(r => r.id !== id);
                    renderWeeklyReadings();
                } else {
                    furtherStudy = furtherStudy.filter(r => r.id !== id);
                    renderFurtherStudy();
                }
            }
        }

        function renderPage1Questions() {
            const list = document.getElementById('page1-questions-list');
            list.innerHTML = '';
            if (page1Questions.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No questions added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            page1Questions.forEach((question, index) => {
                const item = document.createElement('div');
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                item.innerHTML = `
                    <strong>Question ${index + 1}:</strong> ${question.text}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editPage1Question(${question.id})">Edit</button>
                        <button class="btn-f red" onclick="deletePage1Question(${question.id})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        function openAddPage1QuestionModal() {
            setFieldValue('question-text', '');
            window.editingPage1 = true;
            window.editingPage1QuestionId = null;
            document.getElementById('question-modal-title').textContent = 'Add Question';
            document.getElementById('question-modal-submit-btn').textContent = 'Add Question';
            document.getElementById('add-question-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function editPage1Question(id) {
            const question = page1Questions.find(q => q.id === id);
            if (question) {
                setFieldValue('question-text', question.text);
                window.editingPage1QuestionId = id;
                window.editingPage1 = true;
                document.getElementById('question-modal-title').textContent = 'Edit Question';
                document.getElementById('question-modal-submit-btn').textContent = 'Save Question';
                document.getElementById('add-question-modal').style.display = 'block';
                document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
            }
        }

        function deletePage1Question(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                page1Questions = page1Questions.filter(q => q.id !== id);
                renderPage1Questions();
            }
        }

        function renderVideos() {
            const list = document.getElementById('video-list');
            list.innerHTML = '';
            if (videos.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No videos added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            videos.forEach(video => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                const durationHtml = video.duration ? `<p style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Duration: ${video.duration}</p>` : '';
                item.innerHTML = `
                    <strong>${video.title}</strong>
                    ${durationHtml}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editVideo(${video.id})">Edit</button>
                        <button class="btn-f red" onclick="deleteVideo(${video.id})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        function openAddVideoModal() {
            document.getElementById('video-title').value = '';
            document.getElementById('video-url').value = '';
            document.getElementById('video-duration').value = '';
            document.getElementById('video-modal-title').textContent = 'Add Resource';
            document.getElementById('video-modal-submit-btn').textContent = 'Add Resource';
            document.getElementById('add-video-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function closeAddVideoModal() {
            document.getElementById('add-video-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
        }

        function addVideo() {
            // Check if this is for Page 5
            if (window.editingPage5Video) {
                addPage5Video();
                return;
            }

            const title = document.getElementById('video-title').value.trim();
            const url = document.getElementById('video-url').value.trim();
            const duration = document.getElementById('video-duration').value.trim();

            if (!title || !url) {
                alert('Please enter both title and URL');
                return;
            }

            // Check if we're editing an existing video
            if (window.editingVideoId) {
                const video = videos.find(v => v.id === window.editingVideoId);
                if (video) {
                    video.title = title;
                    video.url = url;
                    video.duration = duration;
                }
                window.editingVideoId = null;
            } else {
                // Adding new video
                const newVideo = {
                    id: videos.length > 0 ? Math.max(...videos.map(v => v.id)) + 1 : 1,
                    title: title,
                    url: url,
                    duration: duration
                };
                videos.push(newVideo);
            }
            renderVideos();
            closeAddVideoModal();
        }

        function editVideo(id) {
            const video = videos.find(v => v.id === id);
            if (video) {
                document.getElementById('video-title').value = video.title;
                document.getElementById('video-url').value = video.url;
                document.getElementById('video-duration').value = video.duration || '';
                // Store the ID being edited
                window.editingVideoId = id;
                document.getElementById('video-modal-title').textContent = 'Edit Resource';
                document.getElementById('video-modal-submit-btn').textContent = 'Save Resource';
                document.getElementById('add-video-modal').style.display = 'block';
                document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
            }
        }

        function deleteVideo(id) {
            if (confirm('Are you sure you want to delete this video?')) {
                videos = videos.filter(v => v.id !== id);
                renderVideos();
            }
        }

        // Page 5 Video Management Functions
        function renderPage5Videos() {
            const list = document.getElementById('page5-video-list');
            list.innerHTML = '';
            if (page5Videos.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No videos added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            page5Videos.forEach(video => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                const durationHtml = video.duration ? `<p style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Duration: ${video.duration}</p>` : '';
                item.innerHTML = `
                    <strong>${video.title}</strong>
                    ${durationHtml}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editPage5Video(${video.id})">Edit</button>
                        <button class="btn-f red" onclick="deletePage5Video(${video.id})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        function openAddPage5VideoModal() {
            document.getElementById('video-title').value = '';
            document.getElementById('video-url').value = '';
            document.getElementById('video-duration').value = '';
            window.editingPage5Video = true;
            document.getElementById('video-modal-title').textContent = 'Add Resource';
            document.getElementById('video-modal-submit-btn').textContent = 'Add Resource';
            document.getElementById('add-video-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function addPage5Video() {
            const title = document.getElementById('video-title').value.trim();
            const url = document.getElementById('video-url').value.trim();
            const duration = document.getElementById('video-duration').value.trim();

            if (!title || !url) {
                alert('Please enter both title and URL');
                return;
            }

            // Check if we're editing an existing video
            if (window.editingPage5VideoId) {
                const video = page5Videos.find(v => v.id === window.editingPage5VideoId);
                if (video) {
                    video.title = title;
                    video.url = url;
                    video.duration = duration;
                }
                window.editingPage5VideoId = null;
            } else {
                // Adding new video
                const newVideo = {
                    id: page5Videos.length > 0 ? Math.max(...page5Videos.map(v => v.id)) + 1 : 1,
                    title: title,
                    url: url,
                    duration: duration
                };
                page5Videos.push(newVideo);
            }
            renderPage5Videos();
            window.editingPage5Video = false;
            closeAddVideoModal();
        }

        function editPage5Video(id) {
            const video = page5Videos.find(v => v.id === id);
            if (video) {
                document.getElementById('video-title').value = video.title;
                document.getElementById('video-url').value = video.url;
                document.getElementById('video-duration').value = video.duration || '';
                window.editingPage5VideoId = id;
                window.editingPage5Video = true;
                document.getElementById('video-modal-title').textContent = 'Edit Resource';
                document.getElementById('video-modal-submit-btn').textContent = 'Save Resource';
                document.getElementById('add-video-modal').style.display = 'block';
                document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
            }
        }

        function deletePage5Video(id) {
            if (confirm('Are you sure you want to delete this video?')) {
                page5Videos = page5Videos.filter(v => v.id !== id);
                renderPage5Videos();
            }
        }

        function renderReflectionQuestions() {
            const list = document.getElementById('reflection-questions-list');
            list.innerHTML = '';
            if (reflectionQuestions.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 1rem;">No questions added yet</p>';
                autoSaveCreateWeekDraft();
                return;
            }
            reflectionQuestions.forEach((question, index) => {
                const item = document.createElement('div');
                item.style.borderRadius = '6px';
                item.style.padding = '1rem';
                item.style.marginBottom = '1rem';
                item.style.background = '#f0f2f5';
                item.innerHTML = `
                    <strong>Question ${index + 1}:</strong> ${question.text}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end;">
                        <button class="btn-f gold" onclick="editQuestion(${question.id})">Edit</button>
                        <button class="btn-f red" onclick="deleteQuestion(${question.id})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
            autoSaveCreateWeekDraft();
        }

        function openAddQuestionModal() {
            setFieldValue('question-text', '');
            window.editingPage1 = false;
            window.editingQuestionId = null;
            document.getElementById('question-modal-title').textContent = 'Add Question';
            document.getElementById('question-modal-submit-btn').textContent = 'Add Question';
            document.getElementById('add-question-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        function closeAddQuestionModal() {
            document.getElementById('add-question-modal').style.display = 'none';
            document.body.classList.remove('modal-open'); document.documentElement.classList.remove('modal-open');
        }

        function addQuestion() {
            const text = getFieldValue('question-text');

            if (!text) {
                alert('Please enter a question');
                return;
            }

            // Determine if we're working with Page 1 or Page 4 questions
            if (window.editingPage1) {
                // Handle Page 1 questions
                if (window.editingPage1QuestionId) {
                    const question = page1Questions.find(q => q.id === window.editingPage1QuestionId);
                    if (question) {
                        question.text = text;
                    }
                    window.editingPage1QuestionId = null;
                } else {
                    const newQuestion = {
                        id: page1Questions.length > 0 ? Math.max(...page1Questions.map(q => q.id)) + 1 : 1,
                        text: text
                    };
                    page1Questions.push(newQuestion);
                }
                renderPage1Questions();
                window.editingPage1 = false;
            } else {
                // Handle Page 4 questions
                if (window.editingQuestionId) {
                    const question = reflectionQuestions.find(q => q.id === window.editingQuestionId);
                    if (question) {
                        question.text = text;
                    }
                    window.editingQuestionId = null;
                } else {
                    const newQuestion = {
                        id: reflectionQuestions.length > 0 ? Math.max(...reflectionQuestions.map(q => q.id)) + 1 : 1,
                        text: text
                    };
                    reflectionQuestions.push(newQuestion);
                }
                renderReflectionQuestions();
            }
            closeAddQuestionModal();
        }

        function editQuestion(id) {
            const question = reflectionQuestions.find(q => q.id === id);
            if (question) {
                setFieldValue('question-text', question.text);
                // Store the ID being edited
                window.editingQuestionId = id;
                document.getElementById('question-modal-title').textContent = 'Edit Question';
                document.getElementById('question-modal-submit-btn').textContent = 'Save Question';
                document.getElementById('add-question-modal').style.display = 'block';
                document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
            }
        }

        function deleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                reflectionQuestions = reflectionQuestions.filter(q => q.id !== id);
                renderReflectionQuestions();
            }
        }

        async function saveNewWeek() {
            const title = document.getElementById('week-title-input').value.trim();
            const description = getFieldValue('week-description-input');
            const unlockDate = document.getElementById('week-unlock-date-input').value;

            if (!title) {
                showNotification('Please enter a week title', 'error');
                return;
            }

            if (title.length < 3) {
                showNotification('Week title must be at least 3 characters', 'error');
                return;
            }

            if (!description) {
                showNotification('Please enter a week description', 'error');
                return;
            }

            if (!unlockDate) {
                showNotification('Please set an unlock date for this week', 'error');
                return;
            }

            // Collect page data for all 6 pages (use getFieldValue for contenteditable fields)
            const page2IntroText = getFieldValue('page2-intro-text');
            const zoomPrepText = getFieldValue('zoom-prep-text');

            // Validate required fields
            if (page1Questions.length === 0) {
                showNotification('Please add at least one opening reflection question (Page 1)', 'error');
                return;
            }
            if (!page2IntroText) {
                showNotification('Please enter introduction text for the week (Page 2)', 'error');
                return;
            }
            if (reflectionQuestions.length === 0) {
                showNotification('Please add at least one post-zoom reflection question (Page 5)', 'error');
                return;
            }

            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.querySelector('#create-week-modal .btn-f.teal');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = isEditMode ? 'Saving...' : 'Creating...';
            saveBtn.disabled = true;

            // Create page data array with fixed 6-page structure
            const pages = [
                {
                    title: 'Opening Reflection Question',
                    type: 'discussion',
                    questions: [...page1Questions]
                },
                {
                    title: 'Introduction to the Week',
                    type: 'intro',
                    content: page2IntroText,
                    videos: [...videos]
                },
                {
                    title: 'Weekly Reading',
                    type: 'reading',
                    resources: [...weeklyReadings]
                },
                {
                    title: 'Preparation for Zoom Session',
                    type: 'intro',
                    content: zoomPrepText
                },
                {
                    title: 'Post-Zoom Reflection',
                    type: 'discussion',
                    questions: [...reflectionQuestions]
                },
                {
                    title: 'Further Study',
                    type: 'reading',
                    resources: [...furtherStudy],
                    videos: [...page5Videos]
                }
            ];

            // Create week data object
            const weekData = {
                title: title,
                description: description,
                unlockDate: unlockDate,
                pages: pages
            };

            try {
                let result;

                if (isEditMode && editingWeekId) {
                    // Include expectedUpdatedAt for optimistic locking (conflict detection)
                    if (editingWeekUpdatedAt) {
                        weekData.expectedUpdatedAt = editingWeekUpdatedAt;
                    }

                    // Update existing week
                    result = await dataService.updateWeek(currentModuleId, editingWeekId, weekData);

                    if (!result.success) {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;

                        // Special handling for conflict errors
                        if (result.code === 'CONFLICT') {
                            showNotification(result.message, 'warning');
                            closeCreateWeekModal();
                            await renderWeeks();  // Refresh to show latest data
                            return;
                        }

                        showNotification(result.message || 'Failed to update week', 'error');
                        return;
                    }

                    // Update the week in our local array
                    const weekIndex = weeks.findIndex(w => w.id === editingWeekId);
                    if (weekIndex !== -1) {
                        weeks[weekIndex] = { ...weeks[weekIndex], ...weekData };
                    }

                    showNotification(`Week "${title}" updated successfully!`, 'success');
                } else {
                    // Create new week
                    weekData.status = weeks.length === 0 ? 'current' : 'locked';
                    result = await dataService.createWeek(currentModuleId, weekData);

                    if (!result.success) {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                        showNotification(result.message || 'Failed to create week', 'error');
                        return;
                    }

                    const newWeek = result.data;
                    weeks.push(newWeek);

                    showNotification(`Week "${title}" created successfully!`, 'success');
                }

                // Clear the draft since we successfully saved
                dataService.deleteDraft('createWeek');

                // Reset button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;

                // Close modal and refresh
                closeCreateWeekModal();
                await renderWeeks();

                // Hide the draft notice since we just saved it
                document.getElementById('draft-week-notice').style.display = 'none';
            } catch (error) {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                showNotification('Error saving week: ' + error.message, 'error');
            }
        }

        async function loadWeeks() {
            // Load weeks using DataService
            const currentModuleId = dataService.getCurrentModuleId();
            if (currentModuleId) {
                const savedWeeks = await dataService.getWeeks(currentModuleId);
                weeks.length = 0; // Clear array
                weeks.push(...savedWeeks);
            }
            checkForDraft();
        }

        function checkForDraft() {
            const draft = dataService.getDraft('createWeek');
            const draftNotice = document.getElementById('draft-week-notice');

            if (draft && currentView === 'admin') {
                draftNotice.style.display = 'block';
                const draftNameSpan = document.getElementById('draft-week-name');
                draftNameSpan.textContent = draft.title || 'Untitled Week';
            } else {
                draftNotice.style.display = 'none';
            }
        }

        function discardDraft() {
            if (confirm('Are you sure you want to discard your draft week? This cannot be undone.')) {
                dataService.deleteDraft('createWeek');
                document.getElementById('draft-week-notice').style.display = 'none';
            }
        }

        function resumeDraft() {
            // Load the draft data using DataService
            const draft = dataService.getDraft('createWeek');
            if (draft) {
                document.getElementById('week-title-input').value = draft.title || '';
                setFieldValue('week-description-input', draft.description || '');
                document.getElementById('week-unlock-date-input').value = draft.unlockDate || '';
                setFieldValue('page2-intro-text', draft.page2IntroText || '');
                setFieldValue('zoom-prep-text', draft.zoomPrepText || '');
                weeklyReadings = draft.weeklyReadings || [];
                furtherStudy = draft.furtherStudy || [];
                videos = draft.videos || [];
                page5Videos = draft.page5Videos || [];
                page1Questions = draft.page1Questions || [];
                reflectionQuestions = draft.reflectionQuestions || [];

                // Re-render all lists
                renderWeeklyReadings();
                renderFurtherStudy();
                renderVideos();
                renderPage5Videos();
                renderPage1Questions();
                renderReflectionQuestions();
            }

            document.getElementById('create-week-modal').style.display = 'block';
            document.body.classList.add('modal-open'); document.documentElement.classList.add('modal-open');
        }

        window.onload = async function() {
            // Auth guard
            currentUser = await requireActiveUser();
            if (!currentUser) return;

            // Render user header
            renderUserHeader();

            // Check if module exists
            const currentModuleId = dataService.getCurrentModuleId();
            console.log('DEBUG: currentModuleId =', currentModuleId, 'type:', typeof currentModuleId);

            if (!currentModuleId) {
                alert('No module selected.');
                window.location.href = 'index.html';
                return;
            }

            const currentModule = await dataService.getModule(currentModuleId);
            console.log('DEBUG: currentModule =', currentModule);

            if (!currentModule) {
                alert('Module not found (ID: ' + currentModuleId + '). It may have been deleted.');
                dataService.setCurrentModuleId(null);
                window.location.href = 'index.html';
                return;
            }

            // Check module access (admin can access all, students need enrollment)
            if (currentUser.role !== 'admin') {
                const hasAccess = await canAccessModule(currentUser, currentModuleId);
                if (!hasAccess) {
                    alert('You do not have access to this module.');
                    window.location.href = 'index.html';
                    return;
                }
            }

            // Check for participant mode (admin viewing as student)
            const urlParams = new URLSearchParams(window.location.search);
            isParticipantMode = urlParams.get('participant') === 'true';

            // Determine view based on user role
            let savedView;
            if (currentUser.role === 'admin' && !isParticipantMode) {
                savedView = 'admin';
            } else {
                savedView = 'student';
            }

            // In participant mode, show banner
            if (isParticipantMode) {
                showParticipantModeBanner();
            }

            // Load weeks and module info in parallel
            await Promise.all([loadWeeks(), loadModuleInfo()]);
            await setView(savedView);
            await displayZoomInfo();

            // Convert textareas to rich text editors BEFORE setting up auto-save
            // so the contenteditable event listeners can be attached
            RichText.convertAllTextareas('textarea');

            // Setup auto-save after conversion so it can find contenteditable divs
            setupAutoSave();

            // Show content after everything is loaded
            showContent();
        };

        // Show content and hide loading spinner
        function showContent() {
            const loadingState = document.getElementById('loading-state');
            const mainContent = document.getElementById('main-content');

            loadingState.style.display = 'none';
            mainContent.classList.remove('page-loading');
            mainContent.classList.add('page-loaded');
        }

        function showParticipantModeBanner() {
            const banner = document.createElement('div');
            banner.id = 'participant-mode-banner';
            banner.style.cssText = 'background: rgba(16, 100, 112, 0.15); color: #106470; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(16, 100, 112, 0.3);';
            banner.innerHTML = `
                <span style="font-family: 'Adobe Garamond Pro', Georgia, serif; font-size: 1.05rem;"><strong>Participant Mode</strong> - You are viewing this module as a participant</span>
                <button class="btn-f teal" onclick="exitParticipantMode()">Exit to Admin View</button>
            `;
            const header = document.querySelector('header');
            header.insertAdjacentElement('afterend', banner);

            // Hide view toggle in participant mode
            const viewToggle = document.querySelector('.view-toggle');
            if (viewToggle) {
                viewToggle.style.display = 'none';
            }
        }

        function exitParticipantMode() {
            // Remove participant param and reload as admin
            window.location.href = 'module-overview.html';
        }

        // Auto-save functionality to prevent data loss
        function setupAutoSave() {
            // Auto-save for Edit Module Info modal
            const moduleFields = ['description-input', 'instructor-input', 'duration-input', 'participation-input', 'time-input'];
            moduleFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debounce(function() {
                        autoSaveModuleInfo();
                    }, 1000));
                }
            });

            // Auto-save for Create Week modal
            const weekFields = ['week-title-input', 'week-description-input', 'page2-intro-text', 'zoom-prep-text'];
            weekFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debounce(function() {
                        autoSaveCreateWeekDraft();
                    }, 1000));
                }
            });

            // Also listen to contenteditable divs (rich text editors)
            const editableDivs = document.querySelectorAll('[contenteditable="true"]');
            editableDivs.forEach(div => {
                div.addEventListener('input', debounce(function() {
                    // Determine which auto-save to trigger based on the field's location
                    if (['description-input', 'participation-input', 'time-input'].includes(div.id)) {
                        autoSaveModuleInfo();
                    } else {
                        autoSaveCreateWeekDraft();
                    }
                }, 1000));
            });
        }

        // Debounce function to limit how often auto-save runs
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Format text with support for rich HTML content and plain text fallback
        function formatText(text) {
            if (!text) return '';

            // Check if content contains HTML tags (rich text from editor)
            const hasHTML = /<[^>]+>/.test(text);

            if (hasHTML) {
                // Clean the HTML using RichText utility if available
                let cleaned = typeof RichText !== 'undefined' ? RichText.cleanPastedHTML(text) : text;

                // Ensure links open in new tab and have proper styling
                cleaned = cleaned.replace(/<a\s+href="([^"]*)"(?![^>]*target)/gi, '<a href="$1" target="_blank" style="color: var(--teal); text-decoration: underline;"');

                // Style lists
                cleaned = cleaned.replace(/<ul>/gi, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">');
                cleaned = cleaned.replace(/<ol>/gi, '<ol style="margin: 0.5rem 0; padding-left: 1.5rem;">');

                return cleaned;
            }

            // Plain text fallback - escape HTML and convert line breaks
            const escaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let formatted = escaped.replace(/\n/g, '<br>');

            // Convert markdown-style bullets to HTML list items
            const lines = formatted.split('<br>');
            let inList = false;
            let result = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const isBullet = /^[\*\-\•]\s/.test(line);

                if (isBullet) {
                    if (!inList) {
                        result.push('<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">');
                        inList = true;
                    }
                    const content = line.replace(/^[\*\-\•]\s/, '');
                    result.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    result.push(line + '<br>');
                }
            }

            if (inList) {
                result.push('</ul>');
            }

            return result.join('');
        }

        function autoSaveModuleInfo() {
            const moduleInfo = {
                description: getFieldValue('description-input'),
                instructor: document.getElementById('instructor-input').value,
                duration: document.getElementById('duration-input').value,
                participation: getFieldValue('participation-input'),
                timeExpectations: getFieldValue('time-input'),
                lastAutoSave: new Date().toISOString()
            };
            dataService.saveDraft('moduleInfo', moduleInfo);
            console.log('Module info auto-saved');
        }

        function autoSaveCreateWeekDraft() {
            const weekDraft = {
                title: document.getElementById('week-title-input').value,
                description: getFieldValue('week-description-input'),
                unlockDate: document.getElementById('week-unlock-date-input').value,
                page2IntroText: getFieldValue('page2-intro-text'),
                zoomPrepText: getFieldValue('zoom-prep-text'),
                weeklyReadings: [...weeklyReadings],
                furtherStudy: [...furtherStudy],
                videos: [...videos],
                page5Videos: [...page5Videos],
                page1Questions: [...page1Questions],
                reflectionQuestions: [...reflectionQuestions],
                lastAutoSave: new Date().toISOString()
            };
            dataService.saveDraft('createWeek', weekDraft);
            console.log('Create week draft auto-saved');
        }

        function saveWeekAsDraft() {
            // Manually save current form state as draft
            autoSaveCreateWeekDraft();
            showNotification('Week saved as draft! You can resume editing later.', 'success');
            closeCreateWeekModal();
            checkForDraft(); // Show the draft notice
        }

        function loadCreateWeekDraft() {
            const draft = dataService.getDraft('createWeek');
            if (draft) {
                if (confirm('A draft was found. Would you like to restore it?')) {
                    document.getElementById('week-title-input').value = draft.title || '';
                    setFieldValue('week-description-input', draft.description || '');
                    document.getElementById('week-unlock-date-input').value = draft.unlockDate || '';
                    setFieldValue('page2-intro-text', draft.page2IntroText || '');
                    setFieldValue('zoom-prep-text', draft.zoomPrepText || '');
                    weeklyReadings = draft.weeklyReadings || [];
                    furtherStudy = draft.furtherStudy || [];
                    videos = draft.videos || [];
                    page5Videos = draft.page5Videos || [];
                    page1Questions = draft.page1Questions || [];
                    reflectionQuestions = draft.reflectionQuestions || [];

                    // Re-render all lists
                    renderWeeklyReadings();
                    renderFurtherStudy();
                    renderVideos();
                    renderPage5Videos();
                    renderPage1Questions();
                    renderReflectionQuestions();
                } else {
                    // User declined, clear the draft
                    dataService.deleteDraft('createWeek');
                }
            }
        }

        function loadModuleInfoDraft() {
            const draft = dataService.getDraft('moduleInfo');
            if (draft) {
                setFieldValue('description-input', draft.description || '');
                document.getElementById('instructor-input').value = draft.instructor || '';
                document.getElementById('duration-input').value = draft.duration || '';
                setFieldValue('participation-input', draft.participation || '');
                setFieldValue('time-input', draft.timeExpectations || '');
            }
        }

        async function saveModuleProgress() {
            // Save all module info and weeks to ensure everything is persisted
            const currentModuleId = dataService.getCurrentModuleId();

            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            const currentModule = await dataService.getModule(currentModuleId);

            if (currentModule) {
                // Keep module as draft (template) status
                showNotification('Module template saved successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 500);
            } else {
                showNotification('Module not found', 'error');
            }
        }

        async function launchModule() {
            const currentModuleId = dataService.getCurrentModuleId();

            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            // Check if there are any weeks
            if (weeks.length === 0) {
                showNotification('Please add at least one week before launching the module', 'error');
                return;
            }

            // Check all weeks have unlock dates
            const missingUnlockDates = weeks.filter(w => !w.unlockDate);
            if (missingUnlockDates.length > 0) {
                showNotification('All weeks must have unlock dates before launching. Missing: Week(s) ' + missingUnlockDates.map(w => w.id).join(', '), 'error');
                return;
            }

            // Confirm launch
            if (!confirm('Launch this module?\n\nThis will create a copy of your template that students can access. Your original template will remain editable for future use.')) {
                return;
            }

            // Launch module using DataService
            const result = await dataService.launchModule(currentModuleId);

            if (result.success) {
                showNotification('Module launched successfully! Students can now access it based on unlock dates.', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } else {
                showNotification(result.message || 'Failed to launch module', 'error');
            }
        }

        // Save changes directly to an active module
        async function saveActiveModule() {
            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            const currentModule = await dataService.getModule(currentModuleId);
            if (!currentModule || currentModule.status !== 'launched') {
                showNotification('This feature is only available for active modules', 'error');
                return;
            }

            showNotification('Changes saved to active module!', 'success');
        }

        // Open the Update Active Modules modal (for templates)
        async function openUpdateActiveModulesModal() {
            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            const modal = document.getElementById('update-active-modules-modal');
            const listContainer = document.getElementById('active-modules-list');
            const syncBtn = document.getElementById('sync-selected-btn');

            // Show modal with loading state
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
            listContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">Loading active modules...</div>';
            syncBtn.disabled = true;

            // Fetch all active modules
            const activeModules = await dataService.getActiveModules();

            if (activeModules.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">No active modules found. Launch a module first to sync changes.</div>';
                return;
            }

            // Render checkboxes for each active module
            listContainer.innerHTML = activeModules.map(module => `
                <label style="display: flex; align-items: center; padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <input type="checkbox" class="active-module-checkbox" value="${module.id}" style="margin-right: 0.75rem; width: 18px; height: 18px;">
                    <div>
                        <strong>${module.title}</strong>
                        <div style="font-size: 0.85rem; color: #6c757d;">${module.instructor || 'No instructor'} · Launched ${module.launchedAt ? new Date(module.launchedAt).toLocaleDateString() : 'Unknown'}</div>
                    </div>
                </label>
            `).join('');

            // Add event listeners for checkboxes to enable/disable the sync button
            listContainer.querySelectorAll('.active-module-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSyncButtonState);
            });
        }

        function updateSyncButtonState() {
            const checkedBoxes = document.querySelectorAll('.active-module-checkbox:checked');
            document.getElementById('sync-selected-btn').disabled = checkedBoxes.length === 0;
        }

        function closeUpdateActiveModulesModal() {
            document.getElementById('update-active-modules-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // Sync template to selected active modules
        async function syncSelectedModules() {
            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No template selected', 'error');
                return;
            }

            const checkedBoxes = document.querySelectorAll('.active-module-checkbox:checked');
            const selectedModuleIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            if (selectedModuleIds.length === 0) {
                showNotification('Please select at least one module to update', 'error');
                return;
            }

            // Confirm sync
            const moduleCount = selectedModuleIds.length;
            if (!confirm(`Update ${moduleCount} active module${moduleCount > 1 ? 's' : ''} from this template?\n\nThis will sync module info and week content.\nStudent discussions and progress will be preserved.`)) {
                return;
            }

            closeUpdateActiveModulesModal();

            // Sync each selected module
            let successCount = 0;
            let failCount = 0;

            for (const moduleId of selectedModuleIds) {
                const result = await dataService.syncToActiveModule(currentModuleId, moduleId);
                if (result.success) {
                    successCount++;
                } else {
                    failCount++;
                    console.error(`Failed to sync to module ${moduleId}:`, result.message);
                }
            }

            if (failCount === 0) {
                showNotification(`Successfully updated ${successCount} module${successCount > 1 ? 's' : ''}!`, 'success');
            } else if (successCount === 0) {
                showNotification(`Failed to update modules. Please try again.`, 'error');
            } else {
                showNotification(`Updated ${successCount} module${successCount > 1 ? 's' : ''}, ${failCount} failed.`, 'warning');
            }
        }

        async function deleteWeek(weekId) {
            if (!confirm('Are you sure you want to delete this week?\n\nThis action cannot be undone.')) {
                return;
            }

            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                showNotification('No module selected', 'error');
                return;
            }

            const result = await dataService.deleteWeek(currentModuleId, weekId);

            if (result.success) {
                showNotification('Week deleted successfully', 'success');
                // Reload the page to refresh the week list
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                showNotification(result.message || 'Failed to delete week', 'error');
            }
        }

        // Export functions to window for onclick handlers
        window.setView = setView;
        window.logoutUser = logout;
        window.exitParticipantMode = exitParticipantMode;
        window.openCreateWeekModal = openCreateWeekModal;
        window.openEditWeekModal = openEditWeekModal;
        window.closeCreateWeekModal = closeCreateWeekModal;
        window.openEditDescriptionModal = openEditDescriptionModal;
        window.closeEditDescriptionModal = closeEditDescriptionModal;
        window.saveDescription = saveDescription;
        window.saveNewWeek = saveNewWeek;
        window.saveWeekAsDraft = saveWeekAsDraft;
        window.discardDraft = discardDraft;
        window.resumeDraft = resumeDraft;
        window.openAddResourceModal = openAddResourceModal;
        window.closeAddResourceModal = closeAddResourceModal;
        window.addResource = addResource;
        window.editResource = editResource;
        window.closeEditResourceModal = closeEditResourceModal;
        window.saveResourceEdit = saveResourceEdit;
        window.deleteResource = deleteResource;
        window.checkResourceUrl = checkResourceUrl;
        window.openAddPage1QuestionModal = openAddPage1QuestionModal;
        window.editPage1Question = editPage1Question;
        window.deletePage1Question = deletePage1Question;
        window.openAddVideoModal = openAddVideoModal;
        window.closeAddVideoModal = closeAddVideoModal;
        window.addVideo = addVideo;
        window.editVideo = editVideo;
        window.deleteVideo = deleteVideo;
        window.openAddPage5VideoModal = openAddPage5VideoModal;
        window.editPage5Video = editPage5Video;
        window.deletePage5Video = deletePage5Video;
        window.openAddQuestionModal = openAddQuestionModal;
        window.closeAddQuestionModal = closeAddQuestionModal;
        window.addQuestion = addQuestion;
        window.editQuestion = editQuestion;
        window.deleteQuestion = deleteQuestion;
        window.saveModuleProgress = saveModuleProgress;
        window.launchModule = launchModule;
        window.saveActiveModule = saveActiveModule;
        window.openUpdateActiveModulesModal = openUpdateActiveModulesModal;
        window.closeUpdateActiveModulesModal = closeUpdateActiveModulesModal;
        window.syncSelectedModules = syncSelectedModules;
        window.deleteWeek = deleteWeek;
        window.dataService = dataService;
    </script>
</body>
</html>
