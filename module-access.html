<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Access - LecternAI</title>
    <link rel="stylesheet" href="styles.css">
    <script src="js/db-schema.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/data-service.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="brand-assets/aquinas-seal.svg" alt="Aquinas Institute" class="logo-icon" style="width: 2.5rem; height: 2.5rem;">
                <h1>LecternAI</h1>
            </div>
            <div class="view-toggle">
                <button onclick="setView('student', true)">Student View</button>
                <button class="active" onclick="setView('admin', true)">Admin View</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="breadcrumb">
            <a href="index.html">Home</a>
            <span>›</span>
            <span id="breadcrumb-module">Active Module</span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="page-title" id="module-title" style="margin-bottom: 0;">Loading...</h2>
            <span class="status-badge status-complete" style="background: var(--teal);">Active</span>
        </div>

        <div class="card" id="module-info">
            <p id="module-description" style="margin-bottom: 1rem;">Loading module information...</p>
            <div style="display: flex; gap: 2rem; color: #6c757d; font-size: 0.9rem;">
                <span id="module-instructor"></span>
                <span id="module-duration"></span>
            </div>
        </div>

        <!-- Weeks List -->
        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Module Weeks</h3>
            <div class="module-list" id="weeks-list">
                <!-- Weeks will be populated by JavaScript -->
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <a href="index.html" class="btn btn-secondary">← Back to Modules</a>
        </div>
    </div>

    <img src="brand-assets/aquinas-seal.svg" alt="" class="decorative-cross" style="width: 20rem; height: 20rem; opacity: 0.05;">

    <script>
        let currentModule = null;
        let weeks = [];

        function setView(view, fromToggle = false) {
            // Only redirect to index.html if explicitly toggling to student view (not on page load)
            if (view === 'student' && fromToggle) {
                dataService.setCurrentView('student');
                location.href = 'index.html';
                return;
            }

            if (view === 'student') {
                dataService.setCurrentView('student');
            } else {
                dataService.setCurrentView('admin');
            }
        }

        function loadModuleData() {
            const currentModuleId = dataService.getCurrentModuleId();
            if (!currentModuleId) {
                location.href = 'index.html';
                return;
            }

            currentModule = dataService.getModule(currentModuleId);
            if (!currentModule || currentModule.status !== 'launched') {
                location.href = 'index.html';
                return;
            }

            weeks = dataService.getWeeks(currentModuleId);

            // Update page content
            document.getElementById('module-title').textContent = currentModule.title;
            document.getElementById('breadcrumb-module').textContent = currentModule.title;
            document.getElementById('module-description').textContent = currentModule.description || 'No description available.';

            if (currentModule.instructor) {
                document.getElementById('module-instructor').innerHTML = `<strong>Instructor:</strong> ${currentModule.instructor}`;
            }
            if (currentModule.duration) {
                document.getElementById('module-duration').innerHTML = `<strong>Duration:</strong> ${currentModule.duration}`;
            }

            renderWeeks();
        }

        function renderWeeks() {
            const weeksList = document.getElementById('weeks-list');
            weeksList.innerHTML = '';

            if (weeks.length === 0) {
                weeksList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No weeks in this module.</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            weeks.forEach(week => {
                const weekItem = document.createElement('div');
                weekItem.className = 'module-item';

                const isUnlocked = !week.unlockDate || week.unlockDate <= today;
                const unlockStatus = isUnlocked ?
                    '<span class="status-badge status-complete" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Unlocked</span>' :
                    `<span class="status-badge status-incomplete" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Unlocks: ${new Date(week.unlockDate).toLocaleDateString()}</span>`;

                weekItem.innerHTML = `
                    <div>
                        <strong style="color: var(--primary-color);">Week ${week.id}: ${week.title}</strong>
                        <p style="color: #6c757d; margin-top: 0.25rem; font-size: 0.9rem;">${week.description || ''}</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        ${unlockStatus}
                        <button class="btn btn-primary" style="padding: 0.4rem 1rem; font-size: 0.9rem;" onclick="accessWeek(${week.id})">Access Week</button>
                    </div>
                `;

                weeksList.appendChild(weekItem);
            });
        }

        function accessWeek(weekId) {
            // Navigate to week viewer (same page for both student and admin)
            location.href = `week-viewer.html?week=${weekId}&page=1`;
        }

        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else {
                notification.style.backgroundColor = '#17a2b8';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 4000);
        }

        window.onload = function() {
            loadModuleData();
        };
    </script>
</body>
</html>
